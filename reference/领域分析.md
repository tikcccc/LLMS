# 领域分析

## 1. 领域实体模块划分

DMS系统按照业务功能划分为以下10个核心模块，每个模块包含相应的领域实体：

| 模块名称 | 领域实体 | 数据库表 | 说明 |
| :--- | :--- | :--- | :--- |
| **文档管理模块** | DocumentDO<br>FileDO<br>DocumentVersionDO<br>DocPath | documents<br>files<br>file_versions<br>doc_paths | 核心业务模块，管理文档、文件夹、版本和路径关系 |
| **上传模块** | UploadTaskDO<br>UploadChunk | upload_task<br>upload_chunk | 处理大文件分片上传任务 |
| **轻量化转换模块** | TranslateTaskDO<br>TranslateClientDO<br>TranslateLog | translate_task<br>translate_client<br>translate_log | 管理3D模型轻量化转换任务和客户端 |
| **批注与问题模块** | DocAnnotationDO<br>IssueDO | doc_annotations<br>issues<br>issue_annotation<br>issue_attachments<br>issue_assignees | 支持模型批注和问题管理功能 |
| **权限管理模块** | DocumentPermissionDO<br>AppPermissionDO | doc_permission<br>app_permission | 实现文档级和应用级权限控制 |
| **回收站模块** | RecycleBinDO | item_recycle_bin | 管理已删除文档的恢复和清理 |
| **存储管理模块** | Storage<br>StorageLog | storage<br>storage_logs | 监控和管理项目存储容量 |
| **操作日志模块** | OperationLogDO | doc_operation_logs | 记录文档操作历史 |
| **文件审批模块** | WorkflowTemplateDO<br>ReviewDO<br>ReviewStepDO<br>ReviewStepCandidateDO<br>ReviewFileSnapshotDO<br>ReviewFinalDecisionDO<br>ReviewEventDO<br>FinalDecisionLabelDO | workflow_templates<br>reviews<br>review_steps<br>review_step_candidates<br>review_file_snapshots<br>review_final_decisions<br>review_events<br>final_decision_labels | 管理文件审批流程、模板、步骤和决策 |
| **文件传输模块** | TransmittalDO<br>TransmittalRecipientDO<br>TransmittalFileSnapshotDO<br>TransmittalEventDO | transmittals<br>transmittal_recipients<br>transmittal_file_snapshots<br>transmittal_events | 外部文件正式传输、收件状态追踪与审计日志 |

## 2. 各模块实体详细属性

### 2.1 文档管理模块



@startuml
!theme plain

entity "documents" as docs {
  * doc_id : bigint <<PK>>
  -- parent_folder_id : bigint <<FK>>
  project_id : bigint
  org_id : int
  owner_id : bigint
  modified_user : bigint
  name : varchar
  original_name : varchar
  type : enum
  -- latest_version_id : bigint <<FK>>
  ref_doc_id : bigint
  ref_version_id : bigint
  created : int
  updated : int
  size : bigint
  file_no : bigint
  access_kind : enum
  deleted : tinyint
}

entity "files" as files {
  * file_id : bigint <<PK>>
  project_id : bigint
  org_id : int
  owner_id : bigint
  original_name : varchar
  size : bigint
  path : varchar
  suffix : varchar
  mime : varchar
  created : int
  updated : int
}

entity "file_versions" as versions {
  * version_id : bigint <<PK>>
  -- file_id : bigint <<FK>>
  version_number : int
  owner_id : bigint
  file_no : bigint
}

entity "doc_paths" as paths {
  * ancestor_id : bigint <<PK>>
  * descendant_id : bigint <<PK>>
  depth : int
  project_id : bigint
}

docs ||--o{ docs : "parent_folder_id"
docs ||--o{ versions : "latest_version_id"
files ||--o{ versions : "file_id"
docs ||--o{ paths : "ancestor_id"
docs ||--o{ paths : "descendant_id"

@enduml

#### DocumentDO（档案实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| docId | DocId | doc_id | 档案唯一标识（主键） |
| parentFolder | DocId | parent_folder_id | 父级文件夹ID（根目录为NULL） |
| projectId | ProjectId | project_id | 所属项目ID |
| orgId | OrgId | org_id | 所属企业ID |
| ownerId | AccountId | owner_id | 创建者用户ID |
| modifiedUser | AccountId | modified_user | 最后修改人ID |
| name | String | name | 文件或文件夹名称 |
| originalName | String | original_name | 原档案名称（删除时记录） |
| type | DocTypeEnum | type | 档案类型（file/folder） |
| latestVersionId | VersionId | latest_version_id | 最新文件版本ID |
| versionNumber | Integer | - | 最新版本号（计算字段） |
| refDocId | DocId | ref_doc_id | 拷贝源档案ID |
| refVersionId | VersionId | ref_version_id | 拷贝源档案版本ID |
| created | Integer | created | 创建时间（10位时间戳） |
| updated | Integer | updated | 更新时间（10位时间戳） |
| size | Long | size | 最新文件大小（文件夹为NULL） |
| fileNo | FileNo | file_no | 文件流水号 |
| mime | MediaType | - | 媒体类型（计算字段） |
| accessKind | AccessKindEnum | access_kind | 访问类型（none/restrict_write/restrict_read_write） |
| deleted | Boolean | deleted | 是否已删除 |
| fileId | FileId | - | 文件ID（关联字段） |
| uploadTaskId | UploadTaskId | - | 上传任务ID（关联字段） |
| userPermission | PermissionTypeEnum | - | 当前用户权限（查询时填充） |

#### FileDO（文件实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| fileId | FileId | file_id | 文件唯一标识（主键） |
| projectId | ProjectId | project_id | 所属项目ID |
| orgId | OrgId | org_id | 所属企业ID |
| ownerId | AccountId | owner_id | 创建者用户ID |
| originalName | String | original_name | 原文件名称 |
| size | Long | size | 文件大小（单位：byte） |
| path | FilePath | path | 文件相对路径 |
| suffix | String | suffix | 文件后缀名 |
| mime | MediaType | mime | 媒体类型 |
| created | Integer | created | 创建时间（10位时间戳） |
| updated | Integer | updated | 更新时间（10位时间戳） |
| randomName | String | random_name | 随机文件名 |
| fileVersion | FileVersion | - | 文件版本信息（关联字段） |

#### DocumentVersionDO（文档版本实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| docId | DocId | - | 档案ID（关联字段） |
| versionId | VersionId | version_id | 版本ID（主键） |
| fileId | FileId | file_id | 关联文件ID |
| fileNo | FileNo | file_no | 文件流水号 |
| versionNumber | Integer | version_number | 文件版本号 |
| ownerId | AccountId | owner_id | 版本创建者用户ID |
| file | FileDO | - | 版本对应的文件实体 |
| translateTask | TranslateTaskDO | - | 轻量化任务记录 |

#### DocPath（文档路径闭包表）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| ancestorId | DocId | ancestor_id | 祖先节点ID |
| descendantId | DocId | descendant_id | 后代节点ID |
| depth | Integer | depth | 层级深度 |
| projectId | ProjectId | project_id | 所属项目ID |

### 2.2 上传模块



@startuml
!theme plain

entity "upload_task" as upload_task {
  * task_id : bigint <<PK>>
  mime : varchar
  original_name : varchar
  path : varchar
  suffix : varchar
  size : bigint
  created : int
  updated : int
  status : enum
  chunk_qty : int
  each_chunk_size : int
  project_id : bigint
  org_id : int
  -- parent_folder_id : bigint <<FK>>
  -- merged_file_id : bigint <<FK>>
  -- upgrade_doc_id : bigint <<FK>>
  ver_id : bigint
}

entity "upload_chunk" as chunk {
  * chunk_id : bigint <<PK>>
  -- task_id : bigint <<FK>>
  chunk_index : int
  size : bigint
}

entity "documents" as docs {
  * doc_id : bigint <<PK>>
}

entity "files" as files {
  * file_id : bigint <<PK>>
}

upload_task ||--o{ chunk : "task_id"
upload_task }o--|| docs : "parent_folder_id"
upload_task }o--|| docs : "upgrade_doc_id"
upload_task }o--|| files : "merged_file_id"

@enduml

#### UploadTaskDO（上传任务实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| taskId | UploadTaskId | task_id | 上传任务ID（主键） |
| mime | MediaType | mime | 媒体类型 |
| originalName | String | original_name | 文件源名称 |
| path | FilePath | path | 分片文件夹相对路径 |
| suffix | String | suffix | 文件后缀名 |
| size | Long | size | 文件大小 |
| created | Integer | created | 创建时间 |
| updated | Integer | updated | 更新时间 |
| status | UploadTaskStatusEnum | status | 任务状态（waiting/uploading/uploaded/merging/finished/fail） |
| chunkQty | Integer | chunk_qty | 总分片数 |
| eachChunkSize | Integer | each_chunk_size | 每片大小 |
| projectId | ProjectId | project_id | 所属项目ID |
| orgId | OrgId | org_id | 所属企业ID |
| parentFolderId | DocId | parent_folder_id | 父级文件夹ID |
| mergedFileId | FileId | merged_file_id | 合并后的文件ID |
| upgradeDocId | DocId | upgrade_doc_id | 版本更新时关联的档案ID |
| fileNo | FileNo | - | 文件流水号 |
| versionId | VersionId | - | 档案版本ID |
| relativePath | String | - | 分片合并后的相对路径 |
| verId | Long | ver_id | 乐观锁版本号 |
| upgradeMode | DocUpgradeModeEnum | upgrade_doc_mode | 文件更新模式 |

#### UploadChunk（上传分片值对象）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| chunkId | ChunkId | chunk_id | 分片ID（主键） |
| taskId | UploadTaskId | task_id | 上传任务ID |
| index | Integer | chunk_index | 分片下标 |
| size | Long | size | 分片大小 |

### 2.3 轻量化转换模块



@startuml
!theme plain

entity "translate_task" as trans_task {
  * task_id : bigint <<PK>>
  -- doc_id : bigint <<FK>>
  progress : tinyint
  -- assigned_client_id : int <<FK>>
  status : enum
  owner_id : bigint
  description : varchar
  sort_num : int
  reply_message : varchar
  resource_size : bigint
  created : int
  updated : int
}

entity "translate_client" as trans_client {
  * client_id : int <<PK>>
  client_key : varchar <<UK>>
  client_secret : varchar
  client_name : varchar
  completed_qty : int
  error_qty : int
  assigned_qty : int
  disabled : tinyint
  deleted : tinyint
  created : int
}

entity "translate_log" as trans_log {
  * log_id : bigint <<PK>>
  -- task_id : bigint <<FK>>
  log : varchar
  status : enum
  created : int
}

entity "documents" as docs {
  * doc_id : bigint <<PK>>
}

trans_task }o--|| trans_client : "assigned_client_id"
trans_task ||--o{ trans_log : "task_id"
trans_task }o--|| docs : "doc_id"

@enduml

#### TranslateTaskDO（转换任务实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| taskId | TransTaskId | task_id | 任务ID（主键） |
| docId | DocId | doc_id | 文件档案ID |
| engineType | ModelEngineEnum | - | 引擎类型（计算字段） |
| projectId | ProjectId | - | 所属项目ID（关联字段） |
| versionId | VersionId | - | 文档版本ID（关联字段） |
| ownerId | AccountId | owner_id | 创建者用户ID |
| assignedClientId | TransClientId | assigned_client_id | 已分配的客户端ID |
| status | TransTaskStatusEnum | status | 任务状态（default/assigned/waiting/processing/completed/error） |
| desc | String | description | 描述信息 |
| sortNum | Integer | sort_num | 排序序号 |
| replyMessage | byte\[\] | reply_message | 转换成功后的回复信息 |
| resourceSize | Long | resource_size | 轻量化后资源文件占用空间（byte） |
| created | Integer | created | 创建时间（10位时间戳） |
| updated | Integer | updated | 更新时间（10位时间戳） |
| params | String | params | 客户端自定义参数 |
| progress | Integer | progress | 进度百分比（0-100） |
| translateQty | Integer | - | 轻量化转换次数（计算字段） |
| replyLog | String | - | 轻量化转换日志（计算字段） |

#### TranslateClientDO（转换客户端实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| clientId | TransClientId | client_id | 客户端ID（主键） |
| clientKey | ClientKey | client_key | 客户端Key |
| clientSecret | ClientSecret | client_secret | 客户端密钥 |
| clientName | String | client_name | 客户端名称 |
| completedQty | Integer | completed_qty | 累计完成任务数量 |
| errorQty | Integer | error_qty | 累计处理任务失败数量 |
| assignedQty | Integer | assigned_qty | 累计被分配任务数量 |
| engineType | ModelEngineEnum | - | 引擎类型（计算字段） |
| disabled | Disabled | disabled | 是否已被禁用 |
| deleted | Deleted | deleted | 是否已删除 |
| created | Long | created | 创建时间（10位时间戳） |
| params | String | params | 客户端预设的自定义参数 |
| pickedTask | TaskForTranslate | - | 已拾取的任务 |

#### TranslateLog（转换日志实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| logId | Long | log_id | 日志ID（主键） |
| taskId | TransTaskId | task_id | 关联的任务ID |
| log | String | log | 日志详细信息 |
| status | TransTaskStatusEnum | status | 当前任务状态 |
| created | Integer | created | 创建时间（10位时间戳） |

### 2.4 批注与问题模块



@startuml
!theme plain

entity "doc_annotations" as annotations {
  * annotation_id : bigint <<PK>>
  project_id : bigint
  org_id : int
  -- doc_id : bigint <<FK>>
  -- doc_version_id : bigint <<FK>>
  name : varchar
  description : varchar
  created_by : bigint
  image_url : varchar
  canvas : blob
  version_number : varchar
  created : int
  updated : int
  deleted : tinyint
}

entity "issues" as issues {
  * issue_id : bigint <<PK>>
  project_id : bigint
  org_id : int
  project_app_id : bigint
  number : varchar
  name : varchar
  description : varchar
  completed : int
  status : varchar
  created_by : bigint
  created : int
  updated : int
  deleted : tinyint
}

entity "issue_annotation" as issue_ann {
  * issue_annotation_id : bigint <<PK>>
  -- issue_id : bigint <<FK>>
  -- annotation_id : bigint <<FK>>
  created : int
}

entity "issue_attachments" as issue_att {
  * issue_image_id : bigint <<PK>>
  -- issue_id : bigint <<FK>>
  attachment : varchar
  created : int
}

entity "issue_assignees" as issue_assign {
  * issue_assignee_id : bigint <<PK>>
  -- issue_id : bigint <<FK>>
  assignee_id : bigint
  created : int
}

entity "documents" as docs {
  * doc_id : bigint <<PK>>
}

entity "file_versions" as versions {
  * version_id : bigint <<PK>>
}

issues ||--o{ issue_ann : "issue_id"
issues ||--o{ issue_att : "issue_id"
issues ||--o{ issue_assign : "issue_id"
annotations ||--o{ issue_ann : "annotation_id"
annotations }o--|| docs : "doc_id"
annotations }o--|| versions : "doc_version_id"

@enduml

#### DocAnnotationDO（批注实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| annotationId | AnnotationId | annotation_id | 批注ID（主键） |
| projectId | ProjectId | project_id | 项目ID |
| orgId | OrgId | org_id | 企业ID |
| docId | DocId | doc_id | 文档ID |
| docName | String | - | 文档名称（计算字段） |
| name | String | name | 批注名称 |
| description | String | description | 批注描述 |
| createBy | AccountId | created_by | 创建人ID |
| imageUrl | String | image_url | 批注图片URL |
| canvas | JSONObject | canvas | 批注内容（JSON格式） |
| docVersionId | VersionId | doc_version_id | 文档版本ID |
| versionNumber | String | version_number | 文档版本号 |
| created | Integer | created | 创建时间（10位时间戳） |
| document | DocumentDO | - | 关联文档实体 |

#### IssueDO（问题实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| issueId | IssueId | issue_id | 问题ID（主键） |
| projectId | ProjectId | project_id | 项目ID |
| orgId | OrgId | org_id | 企业ID |
| projectAppId | ProjectAppId | project_app_id | 项目应用ID |
| name | String | name | 问题名称 |
| description | String | description | 问题描述 |
| number | String | number | 问题编号 |
| createBy | AccountId | created_by | 创建人ID |
| completed | Integer | completed | 完成时间（10位时间戳） |
| status | IssueStatusEnum | status | 问题状态（uncompleted/completed） |
| assignees | List&lt;AccountId&gt; | - | 指派人列表（关联表） |
| attachments | List&lt;String&gt; | - | 附件列表（关联表） |
| annotations | List&lt;AnnotationId&gt; | - | 批注列表（关联表） |
| created | Integer | created | 创建时间（10位时间戳） |

### 2.5 权限管理模块



@startuml
!theme plain

entity "doc_permission" as doc_perm {
  * permission_id : bigint <<PK>>
  -- doc_id : bigint <<FK>>
  project_id : bigint
  org_id : int
  project_role_id : bigint
  user_id : bigint
  permission_type : enum
  access_kind : enum
}

entity "app_permission" as app_perm {
  * permission_id : bigint <<PK>>
  org_id : int
  project_id : bigint
  project_role_id : bigint
  user_id : bigint
  permission_type : enum
}

entity "documents" as docs {
  * doc_id : bigint <<PK>>
}

doc_perm }o--|| docs : "doc_id"

@enduml

#### DocumentPermissionDO（文档权限实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| docPermissionId | DocPermissionId | permission_id | 权限ID（主键） |
| docId | DocId | doc_id | 文件或文件夹ID |
| projectId | ProjectId | project_id | 所属项目ID |
| orgId | OrgId | org_id | 所属企业ID |
| projectRoleId | ProjectRoleId | project_role_id | 项目角色ID（针对角色的权限） |
| accountId | AccountId | user_id | 用户ID（针对用户的权限） |
| accessKind | AccessKindEnum | access_kind | 访问限制性质（none/restrict_write/restrict_read_write） |
| permissionType | PermissionTypeEnum | permission_type | 权限类型（read/readWrite/delete/all） |
| accessUser | UserDO | - | 用户信息（关联字段） |
| accessProjectRole | RoleDO | - | 角色信息（关联字段） |

#### AppPermissionDO（应用权限实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| permissionId | AppPermissionId | permission_id | 权限ID（主键） |
| projectId | ProjectId | project_id | 所属项目ID |
| orgId | OrgId | org_id | 所属企业ID |
| userId | AccountId | user_id | 用户ID（针对特定用户的权限） |
| projectRoleId | ProjectRoleId | project_role_id | 项目角色ID（针对特定角色的权限） |
| permissionType | PermissionTypeEnum | permission_type | 权限类型（read/readWrite/delete/all） |

### 2.6 回收站模块



@startuml
!theme plain

entity "item_recycle_bin" as recycle {
  * recycle_id : bigint <<PK>>
  -- doc_id : bigint <<FK>>
  created : int
  deleted : tinyint
  org_id : int
  project_id : bigint
  owner_id : bigint
  updated : int
  -- parent_folder_id : bigint <<FK>>
}

entity "documents" as docs {
  * doc_id : bigint <<PK>>
}

recycle }o--|| docs : "doc_id"
recycle }o--|| docs : "parent_folder_id"

@enduml

#### RecycleBinDO（回收站实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| recycleId | RecycleId | recycle_id | 回收站条目ID（主键） |
| docId | DocId | doc_id | 被删除的文件或文件夹ID |
| created | Integer | created | 删除时间（10位时间戳） |
| deleted | Boolean | deleted | 是否已经删除 |
| orgId | OrgId | org_id | 所属企业ID |
| projectId | ProjectId | project_id | 所属项目ID |
| ownerId | AccountId | owner_id | 创建者用户ID（即删除文件的用户） |
| updated | Integer | updated | 最后更新时间 |
| parentFolderId | DocId | parent_folder_id | 父级目录ID |

### 2.7 存储管理模块



@startuml
!theme plain

entity "storage" as storage {
  * storage_id : bigint <<PK>>
  total : bigint
  used : bigint
  org_id : int
  project_id : bigint
  updated : int
}

entity "storage_logs" as storage_log {
  * log_id : bigint <<PK>>
  -- storage_id : bigint <<FK>>
  file_type : enum
  kind : enum
  used : bigint
  doc_id : bigint
  created : int
  deleted : tinyint
  description : varchar
  target_id : json
}

storage ||--o{ storage_log : "storage_id"

@enduml

#### Storage（存储实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| storageId | StorageId | storage_id | 容量记录ID（主键） |
| total | Long | total | 总容量（默认100GiB，单位byte） |
| used | Long | used | 已使用容量（单位byte） |
| orgId | OrgId | org_id | 所属企业ID |
| projectId | ProjectId | project_id | 所属项目ID |
| updated | Integer | updated | 最后更新时间（10位时间戳） |
| log | StorageLog | - | 容量日志记录 |

#### StorageLog（存储日志值对象）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| logId | StorageLogId | log_id | 日志ID（主键） |
| storageId | StorageId | storage_id | 存储容量ID |
| fileType | StorageFileTypeEnum | file_type | 文件类型（other/image/video/voice/model/model_cache/document/cache） |
| kind | StorageUseKindEnum | kind | 性质（increased/used） |
| used | Long | used | 当前使用容量（单位byte） |
| docId | DocId | doc_id | 档案ID（使用容量时记录） |
| created | Integer | created | 创建时间（10位时间戳） |
| deleted | Boolean | deleted | 是否已删除（已删除代表释放了容量） |
| description | String | description | 备注信息 |
| targetId | JSON | target_id | 目标ID（JSON格式，类型为cache时，为上传任务ID） |

### 2.8 操作日志模块



@startuml
!theme plain

entity "doc_operation_logs" as op_log {
  * log_id : bigint <<PK>>
  user_id : bigint
  operation_type : enum
  -- doc_id : bigint <<FK>>
  original_name : varchar
  new_name : varchar
  -- original_parent_id : bigint <<FK>>
  -- new_parent_id : bigint <<FK>>
  org_id : int
  project_id : bigint
  created : int
  status : tinyint
  additional_info : json
  doc_type : enum
}

entity "documents" as docs {
  * doc_id : bigint <<PK>>
}

op_log }o--|| docs : "doc_id"
op_log }o--|| docs : "original_parent_id"
op_log }o--|| docs : "new_parent_id"

@enduml

#### OperationLogDO（操作日志实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| logId | DocLogId | log_id | 日志唯一标识（主键） |
| userId | AccountId | user_id | 执行操作的用户ID |
| operationType | DocumentOperationTypeEnum | operation_type | 操作类型（CREATE/DELETE/MOVE/RENAME/RESTORE/COPY） |
| docId | DocId | doc_id | 被操作的文档ID |
| originalName | String | original_name | 操作前的文件/文件夹名 |
| newName | String | new_name | 操作后的文件/文件夹名 |
| originalParentId | DocId | original_parent_id | 操作前的父文件夹ID |
| newParentId | DocId | new_parent_id | 操作后的父文件夹ID |
| orgId | OrgId | org_id | 组织ID |
| projectId | ProjectId | project_id | 项目ID |
| created | Integer | created | 操作发生的时间戳（10位） |
| status | Boolean | status | 操作状态（true成功，false失败） |
| additionalInfo | String | additional_info | 附加信息（JSON格式） |
| docType | DocTypeEnum | doc_type | 档案类型（file/folder） |

### 2.9 文件审批模块



@startuml
!theme plain

entity "workflow_templates" as workflow {
  * template_id : bigint <<PK>>
  name : varchar
  description : text
  is_enabled : tinyint
  review_step_number : tinyint
  -- target_folder_id : bigint <<FK>>
  project_id : bigint
  org_id : int
  created_by : bigint
  created : int
  updated : int
  deleted : tinyint
}

entity "final_decision_labels" as labels {
  * label_id : bigint <<PK>>
  -- template_id : bigint <<FK>>
  label_name : varchar
  decision_type : enum
  label_order : int
}

entity "reviews" as reviews {
  * review_id : bigint <<PK>>
  -- template_id : bigint <<FK>>
  -- target_folder_id : bigint <<FK>>
  title : varchar
  description : text
  status : enum
  project_id : bigint
  org_id : int
  created_by : bigint
  closed_by : bigint
  voided_by : bigint
  archived_by : bigint
  created : int
  updated : int
  closed_at : int
  voided_at : int
  archived_at : int
  deleted : tinyint
  chain_id : bigint
  round_no : int
  related_review_id : bigint
}

entity "review_steps" as steps {
  * step_id : bigint <<PK>>
  -- review_id : bigint <<FK>>
  step_number : int
  step_name : varchar
  step_type : enum
  status : enum
  review_mode : enum
  min_approvals : int
  due_duration_days : int
  opened_at : int
  submitted_at : int
  due_date : int
  last_overdue_notified_at : int
  owner_user_id : bigint
  deleted : tinyint
}

entity "review_step_candidates" as candidates {
  * candidate_id : bigint <<PK>>
  -- step_id : bigint <<FK>>
  -- review_id : bigint <<FK>>
  user_id : bigint
  role_id : bigint
  created : int
}

entity "review_step_submissions" as submissions {
  * submission_id : bigint <<PK>>
  -- step_id : bigint <<FK>>
  -- review_id : bigint <<FK>>
  user_id : bigint
  comment : text
  submitted_at : int
}

entity "review_file_snapshots" as file_snapshots {
  * snapshot_id : bigint <<PK>>
  -- review_id : bigint <<FK>>
  -- file_id : bigint <<FK>>
  -- version_id : bigint <<FK>>
  file_path : varchar
  file_name : varchar
  file_size : bigint
  created : int
  copy_result : enum
  copy_result_reason : text
}

entity "review_final_decisions" as final_decisions {
  * decision_id : bigint <<PK>>
  -- review_id : bigint <<FK>>
  -- snapshot_id : bigint <<FK>>
  -- label_id : bigint <<FK>>
  label_name : varchar
  decision_type : enum
  decided_by : bigint
  decided_at : int
}

entity "review_events" as events {
  * event_id : bigint <<PK>>
  -- review_id : bigint <<FK>>
  -- step_id : bigint <<FK>>
  event_type : enum
  user_id : bigint
  event_data : json
  created : int
}

entity "documents" as docs {
  * doc_id : bigint <<PK>>
}

workflow ||--o{ labels : "template_id"
workflow ||--o{ reviews : "template_id"
workflow }o--|| docs : "target_folder_id"
reviews ||--o{ steps : "review_id"
reviews ||--o{ file_snapshots : "review_id"
reviews ||--o{ final_decisions : "review_id"
reviews ||--o{ events : "review_id"
reviews }o--|| docs : "target_folder_id"
steps ||--o{ candidates : "step_id"
steps ||--o{ submissions : "step_id"
steps ||--o{ events : "step_id"
file_snapshots ||--o{ final_decisions : "snapshot_id"
labels ||--o{ final_decisions : "label_id"

@enduml

#### WorkflowTemplateDO（Workflow 模板实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| templateId | TemplateId | template_id | 模板ID（主键） |
| name | String | name | 模板名称（必填） |
| description | String | description | 模板描述 |
| isEnabled | Boolean | is_enabled | 是否启用 |
| reviewStepNumber | Integer | review_step_number | 审批步骤数量（2/3/4） |
| targetFolderId | DocId | target_folder_id | 目标文件夹ID（审批通过后文件复制到此处） |
| projectId | ProjectId | project_id | 所属项目ID |
| orgId | OrgId | org_id | 所属企业ID |
| createdBy | AccountId | created_by | 创建者用户ID（必须是 Project Admin） |
| created | Integer | created | 创建时间（10位时间戳） |
| updated | Integer | updated | 更新时间（10位时间戳） |
| deleted | Boolean | deleted | 是否已删除 |
| allowedInitiators | List&lt;InitiatorConfig&gt; | - | 允许发起审批的用户/角色列表（JSON存储或关联表） |
| stepConfigs | List&lt;StepConfig&gt; | - | 步骤配置列表（JSON存储或关联表） |
| finalLabels | List&lt;FinalDecisionLabelDO&gt; | - | Final 决策标签列表（关联表） |

#### FinalDecisionLabelDO（Final 决策标签实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| labelId | LabelId | label_id | 标签ID（主键） |
| templateId | TemplateId | template_id | 关联模板ID |
| labelName | String | label_name | 标签名称（如 "Approved", "Rejected"） |
| decisionType | DecisionTypeEnum | decision_type | 决策类型（APPROVE/REJECT） |
| labelOrder | Integer | label_order | 标签排序序号 |

#### ReviewDO（文件审批实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| reviewId | ReviewId | review_id | 审批ID（主键） |
| templateId | TemplateId | template_id | 关联模板ID（快照） |
| targetFolderId | DocId | target_folder_id | 目标文件夹ID（快照） |
| title | String | title | 审批标题 |
| description | String | description | 审批描述 |
| status | ReviewStatusEnum | status | 审批状态（Open/Closed/Void） |
| projectId | ProjectId | project_id | 所属项目ID |
| orgId | OrgId | org_id | 所属企业ID |
| createdBy | AccountId | created_by | 发起人用户ID（Initiator） |
| closedBy | AccountId | closed_by | 关闭人用户ID |
| voidedBy | AccountId | voided_by | 作废人用户ID |
| archivedBy | AccountId | archived_by | 归档人用户ID |
| created | Integer | created | 创建时间（10位时间戳） |
| updated | Integer | updated | 更新时间（10位时间戳） |
| closedAt | Integer | closed_at | 关闭时间（10位时间戳） |
| voidedAt | Integer | voided_at | 作废时间（10位时间戳） |
| archivedAt | Integer | archived_at | 归档时间（10位时间戳） |
| deleted | Boolean | deleted | 是否已删除 |
| chainId | ChainId | chain_id | Review Chain ID（重送时关联） |
| roundNo | Integer | round_no | 轮次编号（重送时自增） |
| relatedReviewId | ReviewId | related_review_id | 关联的 Review ID（重送时记录上一轮） |
| steps | List&lt;ReviewStepDO&gt; | - | 审批步骤列表（关联表） |
| fileSnapshots | List&lt;ReviewFileSnapshotDO&gt; | - | 文件快照列表（关联表） |
| finalDecisions | List&lt;ReviewFinalDecisionDO&gt; | - | Final 决策列表（关联表） |
| events | List&lt;ReviewEventDO&gt; | - | 事件日志列表（关联表） |

#### ReviewStepDO（审批步骤实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| stepId | StepId | step_id | 步骤ID（主键） |
| reviewId | ReviewId | review_id | 关联审批ID |
| stepNumber | Integer | step_number | 步骤序号（1/2/3/4） |
| stepName | String | step_name | 步骤名称（Initiation/Review1/Review2/Final） |
| stepType | StepTypeEnum | step_type | 步骤类型（INITIATION/REVIEW1/REVIEW2/FINAL） |
| status | StepStatusEnum | status | 步骤状态（Pending/Open/Submitted） |
| reviewMode | ReviewModeEnum | review_mode | 审批模式（Single/Group） |
| minApprovals | Integer | min_approvals | Group 模式下需要的最少审批数 |
| dueDurationDays | Integer | due_duration_days | 到期天数（从 opened_at 开始计算） |
| openedAt | Integer | opened_at | 步骤开启时间（10位时间戳） |
| submittedAt | Integer | submitted_at | 步骤完成时间（10位时间戳） |
| dueDate | Integer | due_date | 到期时间（10位时间戳，计算字段） |
| lastOverdueNotifiedAt | Integer | last_overdue_notified_at | 最后一次逾期通知时间（用于去重） |
| ownerUserId | AccountId | owner_user_id | 步骤所有者用户ID（严格接手模式下，MinN=1 时记录） |
| deleted | Boolean | deleted | 是否已删除 |
| candidates | List&lt;ReviewStepCandidateDO&gt; | - | 候选者快照列表（关联表） |
| submissions | List&lt;ReviewStepSubmissionDO&gt; | - | 提交记录列表（关联表） |

#### ReviewStepCandidateDO（审批步骤候选者实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| candidateId | CandidateId | candidate_id | 候选者ID（主键） |
| stepId | StepId | step_id | 关联步骤ID |
| reviewId | ReviewId | review_id | 关联审批ID |
| userId | AccountId | user_id | 用户ID（Role 解析后的具体用户） |
| roleId | RoleId | role_id | 角色ID（记录原始 Role，用于审计） |
| created | Integer | created | 创建时间（10位时间戳） |

#### ReviewStepSubmissionDO（审批步骤提交记录实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| submissionId | SubmissionId | submission_id | 提交记录ID（主键） |
| stepId | StepId | step_id | 关联步骤ID |
| reviewId | ReviewId | review_id | 关联审批ID |
| userId | AccountId | user_id | 提交人用户ID |
| comment | String | comment | 提交评论（可选） |
| submittedAt | Integer | submitted_at | 提交时间（10位时间戳） |

**数据库约束**：
- 唯一索引：`unique(step_id, user_id)` - 确保提交幂等性，同一用户对同一步骤只能提交一次

#### ReviewFileSnapshotDO（审批文件快照实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| snapshotId | SnapshotId | snapshot_id | 快照ID（主键） |
| reviewId | ReviewId | review_id | 关联审批ID |
| fileId | FileId | file_id | 文件ID（快照） |
| versionId | VersionId | version_id | 文件版本ID（快照） |
| filePath | String | file_path | 文件路径（快照） |
| fileName | String | file_name | 文件名称（快照） |
| fileSize | Long | file_size | 文件大小（快照） |
| created | Integer | created | 创建时间（10位时间戳） |
| copyResult | CopyResultEnum | copy_result | 复制结果（SUCCESS/FAIL/SKIPPED） |
| copyResultReason | String | copy_result_reason | 复制结果原因（失败或跳过时记录） |
| finalDecision | ReviewFinalDecisionDO | - | Final 决策（关联字段） |

#### ReviewFinalDecisionDO（审批 Final 决策实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| decisionId | DecisionId | decision_id | 决策ID（主键） |
| reviewId | ReviewId | review_id | 关联审批ID |
| snapshotId | SnapshotId | snapshot_id | 关联文件快照ID |
| labelId | LabelId | label_id | 关联决策标签ID |
| labelName | String | label_name | 决策标签名称（快照） |
| decisionType | DecisionTypeEnum | decision_type | 决策类型（APPROVE/REJECT，快照） |
| decidedBy | AccountId | decided_by | 决策人用户ID |
| decidedAt | Integer | decided_at | 决策时间（10位时间戳） |

#### ReviewEventDO（审批事件日志实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| eventId | EventId | event_id | 事件ID（主键） |
| reviewId | ReviewId | review_id | 关联审批ID |
| stepId | StepId | step_id | 关联步骤ID（某些事件关联步骤） |
| eventType | EventTypeEnum | event_type | 事件类型（REVIEW_CREATED/STEP_OPENED/STEP_SUBMITTED/FINAL_DECISION_SAVED/REVIEW_CLOSED/REVIEW_VOIDED/COPY_RESULT_WRITTEN/REVIEW_ARCHIVED） |
| userId | AccountId | user_id | 操作用户ID |
| eventData | JSON | event_data | 事件附加数据（JSON格式） |
| created | Integer | created | 事件发生时间（10位时间戳） |

### 2.10 文件传输模块（Transmittal）



@startuml
!theme plain

entity "transmittals" as transmittals {
  * transmittal_id : bigint <<PK>>
  title : varchar
  message : text
  sender_id : bigint
  project_id : bigint
  org_id : int
  created : int
  updated : int
  deleted : tinyint
}

entity "transmittal_recipients" as recipients {
  * recipient_id : bigint <<PK>>
  -- transmittal_id : bigint <<FK>>
  user_id : bigint
  role_id : bigint
  status : enum
  received_at : int
  viewed_at : int
  downloaded_at : int
  created : int
}

entity "transmittal_file_snapshots" as file_snapshots {
  * snapshot_id : bigint <<PK>>
  -- transmittal_id : bigint <<FK>>
  -- file_id : bigint <<FK>>
  -- version_id : bigint <<FK>>
  file_path : varchar
  file_name : varchar
  file_size : bigint
  created : int
}

entity "transmittal_events" as events {
  * event_id : bigint <<PK>>
  -- transmittal_id : bigint <<FK>>
  user_id : bigint
  event_type : enum
  event_data : json
  created : int
}

entity "files" as files {
  * file_id : bigint <<PK>>
}

entity "file_versions" as versions {
  * version_id : bigint <<PK>>
  -- file_id : bigint <<FK>>
}

transmittals ||--o{ recipients : "transmittal_id"
transmittals ||--o{ file_snapshots : "transmittal_id"
transmittals ||--o{ events : "transmittal_id"
files ||--o{ versions : "file_id"
file_snapshots }o--|| files : "file_id"
file_snapshots }o--|| versions : "version_id"

@enduml

#### TransmittalDO（文件传输实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| transmittalId | TransmittalId | transmittal_id | Transmittal ID（主键） |
| title | String | title | 标题 |
| message | String | message | 发送消息 |
| senderId | AccountId | sender_id | 发件人用户ID |
| projectId | ProjectId | project_id | 所属项目ID |
| orgId | OrgId | org_id | 所属企业ID |
| created | Integer | created | 创建时间（10位时间戳） |
| updated | Integer | updated | 更新时间（10位时间戳） |
| deleted | Boolean | deleted | 是否已删除 |
| recipients | List&lt;TransmittalRecipientDO&gt; | - | 收件人快照列表（关联表） |
| fileSnapshots | List&lt;TransmittalFileSnapshotDO&gt; | - | 文件快照列表（关联表） |
| events | List&lt;TransmittalEventDO&gt; | - | 事件日志列表（关联表） |

#### TransmittalRecipientDO（收件人实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| recipientId | TransmittalRecipientId | recipient_id | 收件人记录ID（主键） |
| transmittalId | TransmittalId | transmittal_id | 关联 Transmittal ID |
| userId | AccountId | user_id | 收件人用户ID |
| roleId | RoleId | role_id | 收件人来源角色ID（可选，记录发送时角色快照） |
| status | TransmittalRecipientStatusEnum | status | 收件状态（Received/Viewed/Downloaded） |
| receivedAt | Integer | received_at | 接收时间（创建即写入） |
| viewedAt | Integer | viewed_at | 查看时间 |
| downloadedAt | Integer | downloaded_at | 下载时间 |
| created | Integer | created | 创建时间（10位时间戳） |

#### TransmittalFileSnapshotDO（文件快照实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| snapshotId | SnapshotId | snapshot_id | 快照ID（主键） |
| transmittalId | TransmittalId | transmittal_id | 关联 Transmittal ID |
| fileId | FileId | file_id | 关联文件ID |
| versionId | VersionId | version_id | 关联文件版本ID |
| filePath | FilePath | file_path | 文件路径（发送时快照） |
| fileName | String | file_name | 文件名（发送时快照） |
| fileSize | Long | file_size | 文件大小（发送时快照） |
| created | Integer | created | 创建时间（10位时间戳） |

#### TransmittalEventDO（传输事件日志实体）

| 属性名称 | 类型 | 数据库字段 | 说明 |
| :--- | :--- | :--- | :--- |
| eventId | EventId | event_id | 事件ID（主键） |
| transmittalId | TransmittalId | transmittal_id | 关联 Transmittal ID |
| userId | AccountId | user_id | 操作用户ID |
| eventType | TransmittalEventTypeEnum | event_type | 事件类型（TRANSMITTAL_CREATED/USER_VIEWED/USER_DOWNLOADED） |
| eventData | JSON | event_data | 事件附加数据（JSON格式） |
| created | Integer | created | 事件发生时间（10位时间戳） |

## 3. 核心实体关系说明

### 3.1 文档管理核心关系

- **documents（档案表）**：系统的核心实体，通过 `parent_folder_id` 自关联形成树形结构
- **doc_paths（路径闭包表）**：使用闭包表模式存储文档的层级关系，支持高效的路径查询
- **files（文件表）**：存储实际文件信息，通过 `file_versions` 关联到 `documents`
- **file_versions（文件版本表）**：管理文件的版本历史，一个文件可以有多个版本

### 3.2 上传流程关系

- **upload_task（上传任务表）**：管理分片上传任务，通过 `parent_folder_id` 关联目标文件夹
- **upload_chunk（上传分片表）**：记录每个分片的上传信息，支持断点续传
- 上传完成后，通过 `merged_file_id` 关联到 `files` 表

### 3.3 轻量化转换关系

- **translate_task（转换任务表）**：通过 `doc_id` 关联文档，通过 `assigned_client_id` 分配转换客户端
- **translate_client（转换客户端表）**：管理轻量化转换引擎客户端
- **translate_log（转换日志表）**：记录转换任务的执行日志

### 3.4 批注与问题关系

- **doc_annotations（批注表）**：通过 `doc_id` 和 `doc_version_id` 关联到特定版本的文档
- **issues（问题表）**：通过关联表 `issue_annotation`、`issue_attachments`、`issue_assignees` 管理问题的批注、附件和指派人

### 3.5 权限管理关系

- **doc_permission（文档权限表）**：实现文档级别的细粒度权限控制，支持用户级和角色级权限
- **app_permission（应用权限表）**：实现应用级别的权限控制，优先级低于文档权限

### 3.6 回收站关系

- **item_recycle_bin（回收站表）**：通过 `doc_id` 关联被删除的文档，保留删除前的 `parent_folder_id` 用于恢复

### 3.7 存储管理关系

- **storage（存储表）**：记录项目的存储容量配置
- **storage_logs（存储日志表）**：记录存储容量的使用和释放历史

### 3.8 操作日志关系

- **doc_operation_logs（操作日志表）**：记录所有文档操作的审计日志，通过 `doc_id` 关联文档

### 3.9 文件审批关系与核心业务规则

#### 3.9.1 实体关系

- **workflow_templates（Workflow 模板表）**：系统的审批流程模板定义，通过 `target_folder_id` 关联目标文件夹
- **final_decision_labels（Final 决策标签表）**：通过 `template_id` 关联模板，定义 Final 步骤可用的决策选项
- **reviews（文件审批表）**：核心实体，通过 `template_id` 关联模板（快照），通过 `target_folder_id` 关联目标文件夹（快照）
- **review_steps（审批步骤表）**：通过 `review_id` 关联审批，定义审批流程的各个步骤（Initiation/Review1/Review2/Final）
- **review_step_candidates（审批步骤候选者表）**：通过 `step_id` 关联步骤，存储步骤候选者快照（Role 解析后的具体用户）
- **review_step_submissions（审批步骤提交记录表）**：通过 `step_id` 关联步骤，记录每个候选者的提交操作（支持幂等去重）
- **review_file_snapshots（审批文件快照表）**：通过 `review_id` 关联审批，存储文件快照信息（file_id + version_id + file_path）
- **review_final_decisions（审批 Final 决策表）**：通过 `snapshot_id` 关联文件快照，通过 `label_id` 关联决策标签，记录每个文件的 Final 决策
- **review_events（审批事件日志表）**：通过 `review_id` 和 `step_id` 关联，记录审批全生命周期的事件流（Timeline）

#### 3.9.2 创建 Review 时的快照机制

- **文件快照**：Review 创建时必须保存每个文件的 `file_id + version_id + file_path`，确保审批过程中查看的文件版本与提交时一致
- **模板快照**：Review 创建时记录 `template_id` 和 `target_folder_id`，后续模板修改不影响已创建的 Review
- **候选者快照**：Step 变为 Open 时，将 Role 解析为具体的 User ID List 并写入 `review_step_candidates`，后续 Role 变更不影响已开始的 Step
- **结构不可变**：Review 创建后，Step 数量、顺序、Step Number 等结构元数据严禁修改

#### 3.9.3 Step 状态机与流转规则

- **状态流转**：Step 状态仅有 Pending → Open → Submitted，任一时刻仅允许 1 个 Step 为 Open
- **Single 模式**：任一候选者提交即完成 Step，其他候选者变为只读
- **Group 模式**：distinct submitter 达到 `min_approvals` 才完成 Step，否则不流转
- **幂等去重**：通过 `unique(step_id, user_id)` 约束实现提交幂等，重复提交不重复计数
- **自动推进**：Step 完成后自动打开下一步（Pending → Open），落地 `opened_at`、`due_date`，resolve 候选者快照并通知

#### 3.9.4 Final 决策与 Close 流程

- **决策必选**：Final 步骤必须对每个文件选择一个 label（`label_name + decision_type`），否则不可 Close
- **Target Folder 校验**：Close 前必须校验 Target Folder 可访问，否则阻断并返回 `409 FOLDER_REFERENCE_BROKEN`
- **终态不可变**：Closed/Void 为终态，阻断所有推进型操作（Submit/Save Final/Close 等）
- **自动化 Copy**：Close 后自动将 `decision_type=APPROVE` 的文件复制到 Target Folder，记录 `copy_result`（SUCCESS/FAIL/SKIPPED）
- **版本一致性**：复制文件时使用快照的 `version_id`，确保与审批时看到的版本一致

#### 3.9.5 权限与可见性控制

- **模板权限**：仅 Project Admin 可创建/修改/启用/停用模板（后端强校验）
- **发起权限**：Create Review 时校验用户在 `allowed_initiators` 名单中或是 Project Admin
- **可见性隔离**：Admin 可见所有 Review；相关人员仅可见自己是 Initiator/Owner/Candidate 的 Review；无关人员访问返回 403
- **My Tasks 筛选**：仅展示 `Review.status=Open` 且 `Current_Step.status=Open` 且当前用户在 `candidate_snapshot` 中的 Review
- **作废权限**：仅 Project Admin 可作废 Review，且仅 status=Open 时允许作废

#### 3.9.6 通知与 Overdue 管理

- **通知触发点**：Review Created、Step Advanced、Review Closed、Step Overdue
- **收件人解析**：通知收件人中的 Role 必须解析为具体用户的 email 或系统账号，与候选者快照一致
- **Overdue 去重**：同一 Step 每日最多发送一封 Overdue 通知，通过 `last_overdue_notified_at` 实现去重
- **Due Date 计算**：Step 变为 Open 时计算 `due_date = opened_at + due_duration_days`（日历日），不提供修改能力

#### 3.9.7 权限计算逻辑（辅助接口）

查询 Review 权限接口（`GET /reviews/{reviewId}/permissions`）基于现有实体数据进行实时权限计算，不涉及新的数据库表。权限计算规则如下：

- **canView（查看权限）**：
  - Admin：true
  - Initiator（`reviews.created_by`）：true
  - Owner（`review_steps.owner_user_id`）：true
  - Candidate（`review_step_candidates.user_id`）：true
  - 其他：false

- **canSubmit（提交当前步骤权限）**：
  - `reviews.status = Open`
  - `review_steps.status = Open`（当前步骤）
  - 用户在当前步骤的 `review_step_candidates` 中
  - 用户尚未提交（检查 `review_step_submissions` 表中不存在 `unique(step_id, user_id)` 记录）

- **canDecide（做 Final 决策权限）**：
  - `reviews.status = Open`
  - 当前步骤类型为 `FINAL`（`review_steps.step_type = FINAL`）
  - `review_steps.status = Open`
  - 用户在 Final Step 的 `review_step_candidates` 中

- **canVoid（作废 Review 权限）**：
  - `reviews.status = Open`
  - 用户是 Project Admin

- **辅助字段**：
  - `currentStepId`：当前 Open 状态的步骤ID（从 `review_steps` 中查询 `status=Open` 的记录）
  - `isCandidate`：用户是否是当前步骤的候选者
  - `isInitiator`：用户是否是 Review 发起人（`reviews.created_by`）
  - `isAdmin`：用户是否是 Project Admin

**设计目的**：
- 统一权限判断逻辑，避免前端重复实现复杂的权限计算
- 支持前端根据权限标识动态显示/隐藏操作按钮
- 便于后续权限规则调整和维护（集中在后端）

### 3.10 文件传输关系与核心业务规则

#### 3.10.1 实体关系

- **transmittals（文件传输表）**：Transmittal 主体记录，包含标题、消息、发件人、项目等基础信息
- **transmittal_recipients（收件人表）**：每个收件人一条记录，保存收件人快照与状态（Received/Viewed/Downloaded）
- **transmittal_file_snapshots（文件快照表）**：发送时冻结文件版本快照，保存 `file_id + version_id + file_path`
- **transmittal_events（事件日志表）**：记录创建、查看、下载等关键操作事件

#### 3.10.2 发送快照与不可变性

- **收件人快照**：发送时将 Role 解析为具体用户并落入 `transmittal_recipients`，后续角色变更不影响已发送记录
- **文件快照**：发送时写入 `file_id + version_id + file_path`，确保后续查看/下载仍指向发送时版本；即使 DMS 中文件被删除/移走或新增，仍以创建快照为准
- **文件夹快照**：选择文件夹时需在发送时展开并固化文件清单与路径，后续目录变更不影响 Transmittal
- **不可变性**：Transmittal 发出后禁止修改标题、收件人、消息、文件清单与版本快照

#### 3.10.3 收件人状态机与更新规则

- **Received**：Transmittal 创建成功时自动写入
- **Viewed**：收件人进入详情页触发（若已 Downloaded 则保持）
- **Downloaded**：点击打包下载触发，优先级最高
- **状态隔离**：状态为每个收件人独立维护，列表/详情展示当前用户状态

#### 3.10.4 可见性与权限控制

- **可见范围**：PM 可见项目内全部 Transmittal；发件人可见自己发出的；收件人（含 Role 解析快照）可见相关记录
- **安全校验**：列表与详情访问需后端强校验，未授权访问返回 403，防止 IDOR
- **文件权限沿用**：文件选择、Viewer 打开与 Folder 跳转沿用 DMS 文件权限；打包下载不受 DMS 权限限制，仅校验 Transmittal 访问权限

#### 3.10.5 通知与审计

- **通知触发**：仅在创建成功时发送邮件通知，收件人以快照为准
- **审计日志**：`transmittal_events` 记录 TRANSMITTAL_CREATED/USER_VIEWED/USER_DOWNLOADED 及时间戳
