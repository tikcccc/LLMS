# 用户故事

<!-- @include: ../项目概览/用户旅程.md#userRole -->

## 用户角色口径

- **设计方/上传者 (Designer / Uploader)**：承建商、BIM工程师、各专业设计师
- **审阅者/协调者 (Reviewer / Coordinator)**：BIM总咨/协调员、技术负责人、专业主管
- **管理者 (Administrator / Manager)**：BIM经理/项目经理、文档控制(DC)、数字化负责人
- **决策方 (Decision Maker)**：项目总监/业主代表、部门主管、最终验收人
- 注：技术支撑角色（系统超级管理员/转换引擎服务账号）仅保障系统稳定，不参与核心业务流程。

## 一、档案管理模块

### 1.1 文件上传相关

#### US-001
作为一个设计方/上传者 (Designer / Uploader)，我希望能够创建大文件上传任务，从而支持分片上传大文件（最大5G），避免因网络问题导致上传失败。

:::tabs
== 业务规则

- BR-001-1: 单个文件上传最大支持5G
- BR-001-2: 创建上传任务后才能进行分片上传
- BR-001-3: 创建成功后返回的任务ID需要客户端自行记录，后续分片上传需要带上任务ID
- BR-001-4: 用户必须是项目成员且项目许可证未过期
- BR-001-5: 创建任务时需要提供组织ID、项目ID、文件名、文件大小等必要信息

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-001-1 | 用户已登录且是项目成员，项目许可证有效，文件大小小于5G | 用户创建上传任务，提供有效的文件信息 | 系统创建任务成功，返回任务ID |
| AC-001-2 | 用户已登录且是项目成员，项目许可证有效，文件大小等于5G | 用户创建上传任务 | 系统创建任务成功，返回任务ID |
| AC-001-3 | 用户已登录且是项目成员，项目许可证有效，文件大小超过5G | 用户创建上传任务 | 系统返回错误，提示文件大小超过限制 |
| AC-001-4 | 用户未登录或不是项目成员 | 用户创建上传任务 | 系统返回权限错误 |
| AC-001-5 | 项目许可证已过期 | 用户创建上传任务 | 系统返回许可证过期错误 |

:::

#### US-002
作为一个设计方/上传者 (Designer / Uploader)，我希望能够进行分片上传文件，从而将大文件分割成多个小片段（每片不超过20M）上传，提高上传成功率和速度。

:::tabs
== 业务规则

- BR-002-1: 每片分片文件大小不能超过20M，建议每片大小为10M
- BR-002-2: 分片上传需要携带有效的任务ID
- BR-002-3: 分片上传需要指定分片序号（chunk index）
- BR-002-4: 用户必须是项目成员且项目许可证未过期
- BR-002-5: 分片上传支持断点续传，可以重复上传同一分片

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-002-1 | 已创建上传任务，分片大小10M，提供有效的任务ID和分片序号 | 用户上传分片文件 | 系统接收分片成功，返回成功响应 |
| AC-002-2 | 已创建上传任务，分片大小20M，提供有效的任务ID和分片序号 | 用户上传分片文件 | 系统接收分片成功，返回成功响应 |
| AC-002-3 | 已创建上传任务，分片大小超过20M | 用户上传分片文件 | 系统返回错误，提示分片大小超过限制 |
| AC-002-4 | 未创建上传任务或任务ID无效 | 用户上传分片文件 | 系统返回错误，提示任务不存在 |
| AC-002-5 | 分片序号重复 | 用户上传相同序号的分片 | 系统覆盖原有分片，返回成功响应 |

:::

#### US-003
作为一个设计方/上传者 (Designer / Uploader)，我希望能够合并已上传的分片文件成完整档案，从而完成大文件的上传流程，生成可用的档案文件。

:::tabs
== 业务规则

- BR-003-1: 合并分片前需要确保所有分片都已上传完成
- BR-003-2: 合并操作需要提供有效的任务ID
- BR-003-3: 合并成功后生成完整的档案文件，档案状态为可用
- BR-003-4: 合并失败时保留已上传的分片，允许重试
- BR-003-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-003-1 | 所有分片已上传完成，提供有效的任务ID | 用户请求合并分片 | 系统合并分片成功，生成完整档案，返回成功响应 |
| AC-003-2 | 部分分片未上传完成 | 用户请求合并分片 | 系统返回错误，提示分片不完整 |
| AC-003-3 | 任务ID无效或不存在 | 用户请求合并分片 | 系统返回错误，提示任务不存在 |
| AC-003-4 | 合并过程中系统异常 | 用户请求合并分片 | 系统返回错误，保留已上传的分片 |
| AC-003-5 | 合并成功后 | 用户查询档案信息 | 系统返回完整的档案信息，状态为可用 |

:::

#### US-004
作为一个设计方/上传者 (Designer / Uploader)，我希望在上传前能够校验文件名是否已存在，从而避免重复上传同名文件，或选择覆盖已有文件。

:::tabs
== 业务规则

- BR-004-1: 校验时需要提供组织ID、项目ID、父文件夹ID和文件名
- BR-004-2: 如果存在同名文件，返回同名文件的ID
- BR-004-3: 如果不存在同名文件，返回null或0
- BR-004-4: 校验操作不修改任何文件，仅用于查询
- BR-004-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-004-1 | 目标文件夹中不存在同名文件 | 用户校验文件名 | 系统返回null或0，表示可以上传 |
| AC-004-2 | 目标文件夹中存在同名文件 | 用户校验文件名 | 系统返回同名文件的ID，用户可选择覆盖 |
| AC-004-3 | 用户提供无效的文件夹ID | 用户校验文件名 | 系统返回错误，提示文件夹不存在 |
| AC-004-4 | 文件名包含特殊字符 | 用户校验文件名 | 系统正常处理，返回校验结果 |
| AC-004-5 | 用户未登录或不是项目成员 | 用户校验文件名 | 系统返回权限错误 |

:::

### 1.2 文件夹管理相关

#### US-005
作为一个设计方/上传者 (Designer / Uploader)，我希望能够创建文件夹来组织我的模型和图纸文件，从而按照项目结构有序管理文件，提高文件查找效率。

:::tabs
== 业务规则

- BR-005-1: 创建文件夹需要提供组织ID、项目ID、父文件夹ID和文件夹名称
- BR-005-2: 同一父文件夹下不能存在同名文件夹
- BR-005-3: 文件夹名称不能包含特殊字符（如 / \ : * ? " < > \|）
- BR-005-4: 创建操作会记录操作日志
- BR-005-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-005-1 | 父文件夹存在，文件夹名称合法，同级无同名文件夹 | 用户创建文件夹 | 系统创建成功，返回成功响应，记录操作日志 |
| AC-005-2 | 父文件夹存在，文件夹名称合法，但同级已存在同名文件夹 | 用户创建文件夹 | 系统返回错误，提示文件夹已存在 |
| AC-005-3 | 父文件夹不存在 | 用户创建文件夹 | 系统返回错误，提示父文件夹不存在 |
| AC-005-4 | 文件夹名称包含特殊字符 | 用户创建文件夹 | 系统返回错误，提示文件夹名称不合法 |
| AC-005-5 | 创建成功后 | 用户查询文件夹列表 | 系统返回新创建的文件夹信息 |

:::

#### US-006
作为一个设计方/上传者 (Designer / Uploader)，我希望能够重命名档案或文件夹，从而修正文件命名错误或统一命名规范。

:::tabs
== 业务规则

- BR-006-1: 重命名需要提供组织ID、项目ID、档案ID和新名称
- BR-006-2: 同一父文件夹下不能存在同名文件或文件夹
- BR-006-3: 新名称不能包含特殊字符
- BR-006-4: 重命名操作会更新档案的更新时间
- BR-006-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-006-1 | 档案存在，新名称合法，同级无同名文件 | 用户重命名档案 | 系统重命名成功，返回成功响应，更新时间更新 |
| AC-006-2 | 档案存在，新名称合法，但同级已存在同名文件 | 用户重命名档案 | 系统返回错误，提示文件名已存在 |
| AC-006-3 | 档案不存在 | 用户重命名档案 | 系统返回错误，提示档案不存在 |
| AC-006-4 | 新名称包含特殊字符 | 用户重命名档案 | 系统返回错误，提示文件名不合法 |
| AC-006-5 | 重命名成功后 | 用户查询档案信息 | 系统返回更新后的档案名称 |

:::

#### US-007
作为一个设计方/上传者 (Designer / Uploader)，我希望能够复制档案到其他位置，从而在不同文件夹中保留文件副本，便于多项目复用。

:::tabs
== 业务规则

- BR-007-1: 复制操作需要提供源档案ID和目标文件夹ID
- BR-007-2: 复制文件夹时会递归复制文件夹下的所有内容
- BR-007-3: 目标文件夹中如果存在同名文件，复制操作会失败
- BR-007-4: 复制操作会创建新的档案记录，保留原档案不变
- BR-007-5: 用户必须是项目成员且项目许可证未过期
- BR-007-6: 复制接口支持可选参数 `version_id`；若传入则复制指定版本到目标文件夹，用于审批关闭后自动复制，保证版本与快照一致。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-007-1 | 源档案存在，目标文件夹存在，目标位置无同名文件 | 用户复制档案 | 系统复制成功，在目标位置创建副本，返回成功响应 |
| AC-007-2 | 源档案存在，目标文件夹存在，但目标位置已存在同名文件 | 用户复制档案 | 系统返回错误，提示文件名冲突 |
| AC-007-3 | 源档案不存在 | 用户复制档案 | 系统返回错误，提示源档案不存在 |
| AC-007-4 | 目标文件夹不存在 | 用户复制档案 | 系统返回错误，提示目标文件夹不存在 |
| AC-007-5 | 复制文件夹时 | 用户复制文件夹 | 系统递归复制文件夹及其所有子文件和子文件夹 |
| AC-007-6 | 源档案存在且有多个版本，目标文件夹存在且无同名冲突 | 用户携带 `version_id` 复制 | 目标位置生成的副本与指定版本一致（而非最新版本） |

:::

#### US-008
作为一个设计方/上传者 (Designer / Uploader)，我希望能够移动档案到其他文件夹，从而调整文件组织结构，保持项目文件结构清晰。

:::tabs
== 业务规则

- BR-008-1: 移动操作需要提供源档案ID和目标文件夹ID
- BR-008-2: 移动文件夹时会递归移动文件夹下的所有内容
- BR-008-3: 目标文件夹中如果存在同名文件，移动操作会失败
- BR-008-4: 不能将文件夹移动到其子文件夹中
- BR-008-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-008-1 | 源档案存在，目标文件夹存在，目标位置无同名文件 | 用户移动档案 | 系统移动成功，档案从原位置移除，移动到目标位置，返回成功响应 |
| AC-008-2 | 源档案存在，目标文件夹存在，但目标位置已存在同名文件 | 用户移动档案 | 系统返回错误，提示文件名冲突 |
| AC-008-3 | 源档案不存在 | 用户移动档案 | 系统返回错误，提示源档案不存在 |
| AC-008-4 | 目标文件夹是源文件夹的子文件夹 | 用户移动文件夹 | 系统返回错误，提示不能移动到子文件夹 |
| AC-008-5 | 移动文件夹时 | 用户移动文件夹 | 系统递归移动文件夹及其所有子文件和子文件夹 |

:::

#### US-009
作为一个设计方/上传者 (Designer / Uploader)，我希望能够将档案移入回收站，从而安全删除不需要的文件，避免误删造成的数据丢失。

:::tabs
== 业务规则

- BR-009-1: 删除操作会将档案移入回收站，而不是物理删除
- BR-009-2: 删除文件夹时，文件夹下的所有档案都会被移入回收站
- BR-009-3: 回收站中的档案保留原位置信息，便于恢复
- BR-009-4: 只有删除档案的用户才能看到该档案在回收站中的记录
- BR-009-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-009-1 | 档案存在，用户有删除权限 | 用户删除档案 | 系统将档案移入回收站，从原位置移除，返回成功响应 |
| AC-009-2 | 文件夹存在，文件夹下有多个文件 | 用户删除文件夹 | 系统将文件夹及其所有子文件移入回收站 |
| AC-009-3 | 档案不存在 | 用户删除档案 | 系统返回错误，提示档案不存在 |
| AC-009-4 | 删除成功后 | 用户查询回收站列表 | 系统返回该用户删除的档案记录 |
| AC-009-5 | 其他用户查询回收站 | 其他用户查询回收站 | 系统不返回该用户删除的档案记录 |

:::

### 1.3 文件查看与导航相关

#### US-010
作为一个审阅者/协调者或决策方，我希望能够搜索档案，从而快速找到需要的文件，支持按名称、更新时间、大小等条件排序。

:::tabs
== 业务规则

- BR-010-1: 搜索支持按档案名称模糊匹配
- BR-010-2: 支持排序字段：updated（更新时间）、name（档案名称）、size（档案大小）
- BR-010-3: 搜索结果只返回用户有权限访问的档案
- BR-010-4: 搜索结果支持分页
- BR-010-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-010-1 | 存在匹配的档案，用户有访问权限 | 用户搜索档案名称 | 系统返回匹配的档案列表，按默认排序 |
| AC-010-2 | 存在匹配的档案，用户有访问权限 | 用户搜索并指定按更新时间排序 | 系统返回匹配的档案列表，按更新时间降序排列 |
| AC-010-3 | 存在匹配的档案，但用户无访问权限 | 用户搜索档案 | 系统不返回该档案 |
| AC-010-4 | 不存在匹配的档案 | 用户搜索档案 | 系统返回空列表 |
| AC-010-5 | 搜索结果超过一页 | 用户搜索档案并指定页码 | 系统返回指定页的搜索结果 |

:::

#### US-011
作为一个审阅者/协调者或决策方，我希望能够获取档案的详细信息，从而了解文件的版本、大小、创建时间等元数据信息。

:::tabs
== 业务规则

- BR-011-1: 获取档案信息需要提供组织ID、项目ID和档案ID
- BR-011-2: 返回信息包括：版本号、文件大小、创建时间、更新时间、创建者等
- BR-011-3: 只有有权限访问的用户才能获取档案信息
- BR-011-4: 文件夹和文件的返回信息结构不同
- BR-011-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-011-1 | 档案存在，用户有访问权限 | 用户获取档案信息 | 系统返回完整的档案信息，包括版本、大小、时间等 |
| AC-011-2 | 档案不存在 | 用户获取档案信息 | 系统返回错误，提示档案不存在 |
| AC-011-3 | 档案存在，但用户无访问权限 | 用户获取档案信息 | 系统返回权限错误 |
| AC-011-4 | 查询文件夹时 | 用户获取文件夹信息 | 系统返回文件夹信息，包括子文件数量等 |
| AC-011-5 | 查询文件时 | 用户获取文件信息 | 系统返回文件信息，包括文件大小、MIME类型等 |

:::

#### US-012
作为一个审阅者/协调者或决策方，我希望能够查看档案的文件树结构，从而了解文件夹的层级关系和子文件列表。

:::tabs
== 业务规则

- BR-012-1: 查询文件树需要提供组织ID、项目ID和档案ID
- BR-012-2: 返回树形结构，包含文件夹的层级关系和子文件列表
- BR-012-3: 只返回用户有权限访问的文件和文件夹
- BR-012-4: 支持递归查询子文件夹的内容
- BR-012-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-012-1 | 文件夹存在，包含多个子文件和子文件夹，用户有访问权限 | 用户查询文件树 | 系统返回完整的树形结构，包含所有子文件和子文件夹 |
| AC-012-2 | 文件夹存在，但用户无访问权限 | 用户查询文件树 | 系统返回权限错误 |
| AC-012-3 | 文件夹不存在 | 用户查询文件树 | 系统返回错误，提示文件夹不存在 |
| AC-012-4 | 文件夹下包含用户无权限访问的文件 | 用户查询文件树 | 系统不返回该文件 |
| AC-012-5 | 查询根文件夹时 | 用户查询根文件夹树 | 系统返回项目根目录的完整文件树结构 |

:::

#### US-013
作为一个审阅者/协调者或决策方，我希望能够获取档案的面包屑导航路径，从而快速了解当前文件的位置，并能够快速返回上级目录。

:::tabs
== 业务规则

- BR-013-1: 面包屑路径从根目录到当前档案的完整路径
- BR-013-2: 每个路径节点包含档案ID和名称
- BR-013-3: 根目录是路径的第一个节点
- BR-013-4: 当前档案是路径的最后一个节点
- BR-013-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-013-1 | 档案存在，位于多级文件夹下 | 用户获取面包屑 | 系统返回从根目录到当前档案的完整路径 |
| AC-013-2 | 档案位于根目录下 | 用户获取面包屑 | 系统返回根目录和当前档案两个节点 |
| AC-013-3 | 档案不存在 | 用户获取面包屑 | 系统返回错误，提示档案不存在 |
| AC-013-4 | 获取面包屑成功后 | 用户点击路径中的某个节点 | 系统可以导航到对应的文件夹 |
| AC-013-5 | 路径中包含用户无权限访问的文件夹 | 用户获取面包屑 | 系统返回错误或过滤无权限节点 |

:::

### 1.4 文件预览与下载相关

#### US-014
作为一个审阅者/协调者或决策方，我希望能够预览档案文件（图片、视频、音频、Office文档、PDF），从而无需下载即可查看文件内容，提高查看效率。

:::tabs
== 业务规则

- BR-014-1: 预览支持图片、视频、音频及文档（Office、PDF）类型的档案
- BR-014-2: 预览接口支持Range分片请求，支持断点续传
- BR-014-3: 只有有权限访问的用户才能预览档案
- BR-014-4: 预览时返回正确的Content-Type响应头
- BR-014-5: 用户必须是项目成员且项目许可证未过期
- BR-014-6: 预览接口支持可选参数 `version_id`；传入则预览指定版本（用于审批快照），未传则默认最新版本。
- BR-014-7: 当 DMS 权限拒绝访问时，前端提示统一文案：“你没有该文件或文件夹权限，请联系管理者”，且不影响页面其他流程信息阅读。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-014-1 | 档案存在，是图片文件，用户有访问权限 | 用户预览档案 | 系统返回图片内容，Content-Type为image/* |
| AC-014-2 | 档案存在，是PDF文件，用户有访问权限 | 用户预览档案 | 系统返回PDF内容，Content-Type为application/pdf |
| AC-014-3 | 档案存在，是视频文件，用户有访问权限，请求包含Range头 | 用户预览档案 | 系统返回指定范围的内容，响应状态为206 |
| AC-014-4 | 档案存在，但用户无访问权限 | 用户预览档案 | 系统返回权限错误 |
| AC-014-5 | 档案类型不支持预览 | 用户预览档案 | 系统返回错误，提示不支持预览 |
| AC-014-6 | 档案存在且有多个版本，用户有访问权限 | 用户携带 `version_id` 预览 | 系统返回对应版本内容，版本与请求一致 |
| AC-014-7 | DMS 返回无权限 | 用户预览/打开 | 前端展示统一提示文案，且页面其他信息仍可正常查看 |

:::

#### US-015
作为一个审阅者/协调者或决策方，我希望能够下载档案文件，从而获取文件的本地副本，支持Range分片下载以提高下载速度。

:::tabs
== 业务规则

- BR-015-1: 下载只支持文件类型的档案，不支持文件夹
- BR-015-2: 下载接口支持Range分片下载，支持断点续传
- BR-015-3: 只有有权限访问的用户才能下载档案
- BR-015-4: 下载时设置Content-Disposition响应头，指定文件名
- BR-015-5: 用户必须是项目成员且项目许可证未过期
- BR-015-6: 下载接口支持可选参数 `version_id`；传入则下载指定版本文件（用于审批快照版本一致性）。
- BR-015-7: 当 DMS 权限拒绝访问时，前端提示统一文案：“你没有该文件或文件夹权限，请联系管理者”。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-015-1 | 文件存在，用户有访问权限 | 用户下载文件 | 系统返回文件内容，设置Content-Disposition头，下载成功 |
| AC-015-2 | 文件存在，用户有访问权限，请求包含Range头 | 用户下载文件 | 系统返回指定范围的内容，响应状态为206 |
| AC-015-3 | 档案是文件夹 | 用户下载文件夹 | 系统返回错误，提示不支持下载文件夹 |
| AC-015-4 | 文件存在，但用户无访问权限 | 用户下载文件 | 系统返回权限错误 |
| AC-015-5 | 文件不存在 | 用户下载文件 | 系统返回错误，提示文件不存在 |
| AC-015-6 | 档案存在且有多个版本，用户有访问权限 | 用户携带 `version_id` 下载 | 系统返回对应版本文件流 |

:::

#### US-016
作为一个审阅者/协调者或决策方，我希望能够在Web端预览轻量化后的3D模型文件，从而无需安装专业软件（如Revit、CAD）即可查看模型，降低查看门槛。

:::tabs
== 业务规则

- BR-016-1: 预览模型需要模型文件已完成轻量化转换
- BR-016-2: 预览接口支持Range分片请求，支持流式加载
- BR-016-3: 只有有权限访问的用户才能预览模型
- BR-016-4: 预览时返回轻量化后的模型资源文件
- BR-016-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-016-1 | 模型文件存在，已完成轻量化转换，用户有访问权限 | 用户预览模型 | 系统返回轻量化模型资源，可以在Web端正常显示 |
| AC-016-2 | 模型文件存在，但未完成轻量化转换 | 用户预览模型 | 系统返回错误，提示模型未转换 |
| AC-016-3 | 模型文件存在，用户有访问权限，请求包含Range头 | 用户预览模型 | 系统返回指定范围的内容，响应状态为206 |
| AC-016-4 | 模型文件存在，但用户无访问权限 | 用户预览模型 | 系统返回权限错误 |
| AC-016-5 | 模型文件不存在 | 用户预览模型 | 系统返回错误，提示文件不存在 |

:::

#### US-017
作为一个审阅者/协调者或决策方，我希望能够通过分享链接预览模型文件，从而允许未登录用户也能查看模型，便于与外部人员协作。

:::tabs
== 业务规则

- BR-017-1: 分享预览接口是免登录访问接口，无需登录即可访问
- BR-017-2: 分享链接需要包含有效的分享令牌或参数
- BR-017-3: 分享预览只返回模型资源，不返回其他敏感信息
- BR-017-4: 分享链接可能有过期时间限制
- BR-017-5: 分享预览接口支持Range分片请求

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-017-1 | 模型文件存在，已完成轻量化转换，分享链接有效 | 未登录用户访问分享链接 | 系统返回轻量化模型资源，可以在Web端正常显示 |
| AC-017-2 | 分享链接无效或已过期 | 未登录用户访问分享链接 | 系统返回错误，提示链接无效 |
| AC-017-3 | 模型文件未完成轻量化转换 | 未登录用户访问分享链接 | 系统返回错误，提示模型未转换 |
| AC-017-4 | 分享链接有效，请求包含Range头 | 未登录用户访问分享链接 | 系统返回指定范围的内容，响应状态为206 |
| AC-017-5 | 分享链接有效 | 未登录用户访问分享链接 | 系统不要求用户登录，直接返回模型资源 |

:::

### 1.5 版本管理相关

#### US-018
作为一个设计方/上传者 (Designer / Uploader)，我希望能够查看档案的所有版本列表，从而了解文件的版本历史，追溯设计变更过程，确保基于最新版本工作。

:::tabs
== 业务规则

- BR-018-1: 版本列表按版本号或创建时间排序，最新版本在前
- BR-018-2: 每个版本包含版本号、创建时间、创建者等信息
- BR-018-3: 只有有权限访问的用户才能查看版本列表
- BR-018-4: 版本列表支持分页
- BR-018-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-018-1 | 档案存在，有多个版本，用户有访问权限 | 用户查看版本列表 | 系统返回所有版本列表，按时间倒序排列 |
| AC-018-2 | 档案存在，只有一个版本 | 用户查看版本列表 | 系统返回包含该版本的列表 |
| AC-018-3 | 档案不存在 | 用户查看版本列表 | 系统返回错误，提示档案不存在 |
| AC-018-4 | 档案存在，但用户无访问权限 | 用户查看版本列表 | 系统返回权限错误 |
| AC-018-5 | 版本列表超过一页 | 用户查看版本列表并指定页码 | 系统返回指定页的版本列表 |

:::

---

## 二、批注管理模块

#### US-019
作为一个审阅者/协调者 (Reviewer / Coordinator)，我希望能够在模型上创建批注，从而标记发现的问题或需要关注的位置，记录视点坐标和描述信息。

:::tabs
== 业务规则

- BR-019-1: 创建批注需要提供组织ID、项目ID、档案ID、视点坐标和描述信息
- BR-019-2: 批注必须关联到具体的模型文件
- BR-019-3: 创建操作会记录操作日志
- BR-019-4: 创建成功后返回批注ID
- BR-019-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-019-1 | 模型文件存在，用户有访问权限，提供有效的批注信息 | 用户创建批注 | 系统创建批注成功，返回批注ID，记录操作日志 |
| AC-019-2 | 模型文件不存在 | 用户创建批注 | 系统返回错误，提示文件不存在 |
| AC-019-3 | 用户未提供视点坐标或描述信息 | 用户创建批注 | 系统返回参数错误 |
| AC-019-4 | 用户无访问权限 | 用户创建批注 | 系统返回权限错误 |
| AC-019-5 | 创建成功后 | 用户查询批注列表 | 系统返回新创建的批注信息 |

:::

#### US-020
作为一个审阅者/协调者 (Reviewer / Coordinator)，我希望能够更新已创建的批注，从而修正批注内容或补充更多信息。

:::tabs
== 业务规则

- BR-020-1: 更新批注需要提供批注ID和要更新的内容
- BR-020-2: 可以更新批注的描述信息、视点坐标等
- BR-020-3: 更新操作会记录操作日志
- BR-020-4: 只有批注创建者或项目管理员可以更新批注
- BR-020-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-020-1 | 批注存在，用户是创建者或管理员，提供有效的更新内容 | 用户更新批注 | 系统更新批注成功，返回成功响应，记录操作日志 |
| AC-020-2 | 批注不存在 | 用户更新批注 | 系统返回错误，提示批注不存在 |
| AC-020-3 | 批注存在，但用户不是创建者且不是管理员 | 用户更新批注 | 系统返回权限错误 |
| AC-020-4 | 更新成功后 | 用户查询批注详情 | 系统返回更新后的批注信息 |
| AC-020-5 | 用户未提供要更新的内容 | 用户更新批注 | 系统返回参数错误 |

:::

#### US-021
作为一个审阅者/协调者 (Reviewer / Coordinator)，我希望能够删除不需要的批注，从而清理过时或错误的标记。

:::tabs
== 业务规则

- BR-021-1: 删除批注需要提供批注ID
- BR-021-2: 删除操作会记录操作日志
- BR-021-3: 只有批注创建者或项目管理员可以删除批注
- BR-021-4: 删除操作是物理删除，不可恢复
- BR-021-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-021-1 | 批注存在，用户是创建者或管理员 | 用户删除批注 | 系统删除批注成功，返回成功响应，记录操作日志 |
| AC-021-2 | 批注不存在 | 用户删除批注 | 系统返回错误，提示批注不存在 |
| AC-021-3 | 批注存在，但用户不是创建者且不是管理员 | 用户删除批注 | 系统返回权限错误 |
| AC-021-4 | 删除成功后 | 用户查询批注列表 | 系统不返回已删除的批注 |
| AC-021-5 | 删除成功后 | 用户查询批注详情 | 系统返回错误，提示批注不存在 |

:::

#### US-022
作为一个设计方/上传者 (Designer / Uploader)，我希望能够查询模型的所有批注列表，从而了解模型上所有的标记和反馈。

:::tabs
== 业务规则

- BR-022-1: 查询批注列表需要提供组织ID、项目ID和档案ID
- BR-022-2: 返回指定模型文件的所有批注
- BR-022-3: 批注列表支持分页
- BR-022-4: 只有有权限访问的用户才能查询批注列表
- BR-022-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-022-1 | 模型文件存在，有多个批注，用户有访问权限 | 用户查询批注列表 | 系统返回所有批注列表，支持分页 |
| AC-022-2 | 模型文件存在，但没有批注 | 用户查询批注列表 | 系统返回空列表 |
| AC-022-3 | 模型文件不存在 | 用户查询批注列表 | 系统返回错误，提示文件不存在 |
| AC-022-4 | 模型文件存在，但用户无访问权限 | 用户查询批注列表 | 系统返回权限错误 |
| AC-022-5 | 批注列表超过一页 | 用户查询批注列表并指定页码 | 系统返回指定页的批注列表 |

:::

#### US-023
作为一个设计方/上传者 (Designer / Uploader)，我希望能够查看批注的详细信息，从而了解批注的具体内容、位置和创建者，便于响应反馈。

:::tabs
== 业务规则

- BR-023-1: 查看批注详情需要提供批注ID
- BR-023-2: 返回信息包括：批注内容、视点坐标、创建者、创建时间等
- BR-023-3: 只有有权限访问的用户才能查看批注详情
- BR-023-4: 批注详情包含关联的模型文件信息
- BR-023-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-023-1 | 批注存在，用户有访问权限 | 用户查看批注详情 | 系统返回完整的批注信息，包括内容、位置、创建者等 |
| AC-023-2 | 批注不存在 | 用户查看批注详情 | 系统返回错误，提示批注不存在 |
| AC-023-3 | 批注存在，但用户无访问权限 | 用户查看批注详情 | 系统返回权限错误 |
| AC-023-4 | 查看批注详情成功后 | 用户点击视点坐标 | 系统可以跳转到模型对应的视点位置 |
| AC-023-5 | 批注关联的模型文件已删除 | 用户查看批注详情 | 系统返回错误或标记模型文件不存在 |

:::

---

## 三、问题管理模块

#### US-024
作为一个审阅者/协调者 (Reviewer / Coordinator)，我希望能够创建问题工单，从而将发现的设计问题（如碰撞、规范不符等）记录为可追踪的任务，并指派给责任人。

:::tabs
== 业务规则

- BR-024-1: 创建问题需要提供组织ID、项目ID、项目应用ID、问题描述、责任人等信息
- BR-024-2: 问题可以关联到具体的模型文件和位置
- BR-024-3: 创建操作会记录操作日志
- BR-024-4: 创建成功后返回问题ID
- BR-024-5: 用户必须是项目成员、项目许可证未过期且有项目应用访问权限

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-024-1 | 用户有权限，提供有效的问题信息（描述、责任人等） | 用户创建问题 | 系统创建问题成功，返回问题ID，记录操作日志 |
| AC-024-2 | 用户未提供问题描述或责任人 | 用户创建问题 | 系统返回参数错误 |
| AC-024-3 | 用户无项目应用访问权限 | 用户创建问题 | 系统返回权限错误 |
| AC-024-4 | 创建成功后 | 责任人收到问题通知 | 系统发送通知给指派的责任人 |
| AC-024-5 | 创建成功后 | 用户查询问题列表 | 系统返回新创建的问题，状态为待处理 |

:::

#### US-025
作为一个设计方/上传者 (Designer / Uploader)，我希望能够更新问题工单的信息，从而修改问题描述、状态或责任人，跟踪问题处理进度。

:::tabs
== 业务规则

- BR-025-1: 更新问题需要提供问题ID和要更新的内容
- BR-025-2: 可以更新问题描述、状态、责任人等信息
- BR-025-3: 更新操作会记录操作日志
- BR-025-4: 只有问题创建者、责任人、项目管理员可以更新问题
- BR-025-5: 用户必须是项目成员、项目许可证未过期且有项目应用访问权限

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-025-1 | 问题存在，用户是创建者/责任人/管理员，提供有效的更新内容 | 用户更新问题 | 系统更新问题成功，返回成功响应，记录操作日志 |
| AC-025-2 | 问题不存在 | 用户更新问题 | 系统返回错误，提示问题不存在 |
| AC-025-3 | 问题存在，但用户无权限更新 | 用户更新问题 | 系统返回权限错误 |
| AC-025-4 | 更新问题状态为处理中 | 用户更新问题状态 | 系统更新状态成功，记录状态变更历史 |
| AC-025-5 | 更新责任人后 | 新责任人收到通知 | 系统发送通知给新的责任人 |

:::

#### US-026
作为一个审阅者/协调者 (Reviewer / Coordinator)，我希望能够删除问题工单，从而清理无效或重复的问题记录。

:::tabs
== 业务规则

- BR-026-1: 删除问题需要提供问题ID
- BR-026-2: 删除操作会记录操作日志
- BR-026-3: 只有问题创建者或项目管理员可以删除问题
- BR-026-4: 删除操作是物理删除，不可恢复
- BR-026-5: 用户必须是项目成员、项目许可证未过期且有项目应用访问权限

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-026-1 | 问题存在，用户是创建者或管理员 | 用户删除问题 | 系统删除问题成功，返回成功响应，记录操作日志 |
| AC-026-2 | 问题不存在 | 用户删除问题 | 系统返回错误，提示问题不存在 |
| AC-026-3 | 问题存在，但用户不是创建者且不是管理员 | 用户删除问题 | 系统返回权限错误 |
| AC-026-4 | 删除成功后 | 用户查询问题列表 | 系统不返回已删除的问题 |
| AC-026-5 | 删除成功后 | 用户查询问题详情 | 系统返回错误，提示问题不存在 |

:::

#### US-027
作为一个设计方/上传者 (Designer / Uploader)，我希望能够查询问题工单列表，从而了解项目中所有待处理和已处理的问题，支持按状态、责任人等条件筛选。

:::tabs
== 业务规则

- BR-027-1: 查询问题列表需要提供组织ID、项目ID和项目应用ID
- BR-027-2: 支持按状态、责任人等条件筛选
- BR-027-3: 问题列表支持分页
- BR-027-4: 只有有权限访问的用户才能查询问题列表
- BR-027-5: 用户必须是项目成员、项目许可证未过期且有项目应用访问权限

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-027-1 | 项目中有多个问题，用户有访问权限 | 用户查询问题列表 | 系统返回所有问题列表，支持分页 |
| AC-027-2 | 项目中有多个问题，用户指定按状态筛选 | 用户查询问题列表并筛选状态 | 系统返回符合状态条件的问题列表 |
| AC-027-3 | 项目中有多个问题，用户指定按责任人筛选 | 用户查询问题列表并筛选责任人 | 系统返回分配给该责任人的问题列表 |
| AC-027-4 | 项目中没有问题 | 用户查询问题列表 | 系统返回空列表 |
| AC-027-5 | 用户无项目应用访问权限 | 用户查询问题列表 | 系统返回权限错误 |

:::

#### US-028
作为一个设计方/上传者 (Designer / Uploader)，我希望能够查看问题工单的详细信息，从而了解问题的完整描述、关联的模型位置、处理历史等信息。

:::tabs
== 业务规则

- BR-028-1: 查看问题详情需要提供问题ID
- BR-028-2: 返回信息包括：问题描述、状态、责任人、关联模型位置、处理历史等
- BR-028-3: 只有有权限访问的用户才能查看问题详情
- BR-028-4: 问题详情包含完整的处理时间线
- BR-028-5: 用户必须是项目成员、项目许可证未过期且有项目应用访问权限

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-028-1 | 问题存在，用户有访问权限 | 用户查看问题详情 | 系统返回完整的问题信息，包括描述、状态、责任人、处理历史等 |
| AC-028-2 | 问题不存在 | 用户查看问题详情 | 系统返回错误，提示问题不存在 |
| AC-028-3 | 问题存在，但用户无访问权限 | 用户查看问题详情 | 系统返回权限错误 |
| AC-028-4 | 问题有关联的模型位置 | 用户查看问题详情 | 系统返回模型位置信息，可以跳转到对应位置 |
| AC-028-5 | 问题有处理历史记录 | 用户查看问题详情 | 系统返回完整的处理时间线，包括状态变更、责任人变更等 |

:::

#### US-029
作为一个设计方/上传者 (Designer / Uploader)，我希望能够将问题标记为已完成，从而关闭已解决的问题，更新问题状态，完成问题处理闭环。

:::tabs
== 业务规则

- BR-029-1: 完成问题需要提供问题ID
- BR-029-2: 完成操作会将问题状态更新为已完成
- BR-029-3: 完成操作会记录操作日志
- BR-029-4: 只有问题创建者、责任人、项目管理员可以完成问题
- BR-029-5: 用户必须是项目成员、项目许可证未过期且有项目应用访问权限

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-029-1 | 问题存在，状态为待处理或处理中，用户是创建者/责任人/管理员 | 用户完成问题 | 系统更新问题状态为已完成，返回成功响应，记录操作日志 |
| AC-029-2 | 问题不存在 | 用户完成问题 | 系统返回错误，提示问题不存在 |
| AC-029-3 | 问题状态已经是已完成 | 用户完成问题 | 系统返回错误或提示问题已完成 |
| AC-029-4 | 问题存在，但用户无权限完成 | 用户完成问题 | 系统返回权限错误 |
| AC-029-5 | 完成问题后 | 问题创建者收到通知 | 系统发送通知给问题创建者，告知问题已完成 |

:::

---

## 四、回收站管理模块

#### US-030
作为一个设计方/上传者 (Designer / Uploader)，我希望能够将回收站中的档案恢复到原位置，从而恢复误删的文件，避免数据丢失。

:::tabs
== 业务规则

- BR-030-1: 恢复档案需要提供回收站记录ID
- BR-030-2: 恢复操作会将档案从回收站移回原位置
- BR-030-3: 如果原位置已存在同名文件，恢复操作会失败
- BR-030-4: 恢复文件夹时会递归恢复文件夹下的所有内容
- BR-030-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-030-1 | 回收站记录存在，原位置不存在同名文件 | 用户恢复档案 | 系统恢复档案成功，档案从回收站移除，回到原位置，返回成功响应 |
| AC-030-2 | 回收站记录存在，但原位置已存在同名文件 | 用户恢复档案 | 系统返回错误，提示文件名冲突 |
| AC-030-3 | 回收站记录不存在 | 用户恢复档案 | 系统返回错误，提示记录不存在 |
| AC-030-4 | 恢复文件夹时 | 用户恢复文件夹 | 系统递归恢复文件夹及其所有子文件和子文件夹 |
| AC-030-5 | 恢复成功后 | 用户查询回收站列表 | 系统不返回已恢复的记录 |

:::

#### US-031
作为一个设计方/上传者 (Designer / Uploader)，我希望能够立即删除回收站中的记录，从而彻底删除不需要的文件，释放存储空间。

:::tabs
== 业务规则

- BR-031-1: 立即删除支持删除多个回收站记录
- BR-031-2: 立即删除是物理删除，不可恢复
- BR-031-3: 删除操作会释放存储空间
- BR-031-4: 只能删除当前用户自己删除的档案记录
- BR-031-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-031-1 | 回收站中有用户自己删除的记录 | 用户立即删除记录 | 系统删除记录成功，物理删除文件，释放存储空间，返回成功响应 |
| AC-031-2 | 回收站中有多个记录 | 用户批量删除多个记录 | 系统删除所有指定记录成功 |
| AC-031-3 | 回收站记录不存在 | 用户立即删除记录 | 系统返回错误，提示记录不存在 |
| AC-031-4 | 回收站记录是其他用户删除的 | 用户立即删除记录 | 系统返回权限错误 |
| AC-031-5 | 删除成功后 | 用户查询回收站列表 | 系统不返回已删除的记录 |

:::

#### US-032
作为一个设计方/上传者 (Designer / Uploader)，我希望能够清空回收站中的所有记录，从而批量清理不需要的文件，提高清理效率。

:::tabs
== 业务规则

- BR-032-1: 清空回收站会删除当前用户在回收站的所有记录
- BR-032-2: 清空操作是物理删除，不可恢复
- BR-032-3: 清空操作需要用户二次确认
- BR-032-4: 清空操作会释放所有相关文件的存储空间
- BR-032-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-032-1 | 回收站中有用户自己删除的多个记录，用户已确认 | 用户清空回收站 | 系统删除所有记录成功，释放存储空间，返回成功响应 |
| AC-032-2 | 回收站中没有记录 | 用户清空回收站 | 系统返回成功响应（无操作） |
| AC-032-3 | 用户未确认清空操作 | 用户请求清空回收站 | 系统要求用户二次确认 |
| AC-032-4 | 清空成功后 | 用户查询回收站列表 | 系统返回空列表 |
| AC-032-5 | 清空操作只影响当前用户的记录 | 用户清空回收站 | 系统只删除当前用户的记录，其他用户的记录不受影响 |

:::

#### US-033
作为一个设计方/上传者 (Designer / Uploader)，我希望能够查询回收站中的记录列表，从而查看已删除的文件，决定是否恢复或彻底删除。

:::tabs
== 业务规则

- BR-033-1: 查询回收站列表只返回当前企业、项目下，当前用户删除的记录
- BR-033-2: 回收站列表支持分页
- BR-033-3: 列表包含档案名称、删除时间、原位置等信息
- BR-033-4: 其他用户删除的记录不会出现在当前用户的回收站列表中
- BR-033-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-033-1 | 回收站中有用户自己删除的多个记录 | 用户查询回收站列表 | 系统返回该用户删除的所有记录列表，支持分页 |
| AC-033-2 | 回收站中没有记录 | 用户查询回收站列表 | 系统返回空列表 |
| AC-033-3 | 回收站中有其他用户删除的记录 | 用户查询回收站列表 | 系统不返回其他用户删除的记录 |
| AC-033-4 | 回收站列表超过一页 | 用户查询回收站列表并指定页码 | 系统返回指定页的记录列表 |
| AC-033-5 | 查询成功后 | 用户查看记录详情 | 系统返回记录的详细信息，包括原位置、删除时间等 |

:::

---

## 五、权限管理模块

#### US-034
作为一个审阅者/协调者或决策方，我希望能够查看根目录文件夹的权限设置，从而了解我在项目中的基础权限（仅查看/下载或无限制）。

:::tabs
== 业务规则

- BR-034-1: 查看根目录权限需要提供组织ID和项目ID
- BR-034-2: 返回结果：restrict_write（仅查看/下载）或none（无限制）
- BR-034-3: 所有项目成员都可以查看根目录权限
- BR-034-4: 根目录权限是项目的基础权限设置
- BR-034-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-034-1 | 用户是项目成员，根目录权限已设置 | 用户查看根目录权限 | 系统返回权限设置，值为restrict_write或none |
| AC-034-2 | 用户是项目成员，根目录权限未设置 | 用户查看根目录权限 | 系统返回默认权限或null |
| AC-034-3 | 用户不是项目成员 | 用户查看根目录权限 | 系统返回权限错误 |
| AC-034-4 | 项目许可证已过期 | 用户查看根目录权限 | 系统返回许可证过期错误 |
| AC-034-5 | 查看权限成功后 | 用户根据权限进行操作 | 系统根据权限设置限制或允许用户操作 |

:::

#### US-035
作为一个管理者 (Administrator / Manager)，我希望能够设置根目录文件夹的权限，从而控制项目成员的基础访问权限，确保数据安全。

:::tabs
== 业务规则

- BR-035-1: 设置根目录权限需要提供组织ID、项目ID和权限值
- BR-035-2: 权限值：restrict_write（仅查看/下载）或none（无限制）
- BR-035-3: 只有项目管理员可以设置根目录权限
- BR-035-4: 设置根目录权限会影响所有项目成员的基础权限
- BR-035-5: 用户必须是项目管理员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-035-1 | 用户是项目管理员，提供有效的权限值 | 用户设置根目录权限 | 系统设置权限成功，返回成功响应 |
| AC-035-2 | 用户不是项目管理员 | 用户设置根目录权限 | 系统返回权限错误 |
| AC-035-3 | 用户提供无效的权限值 | 用户设置根目录权限 | 系统返回参数错误 |
| AC-035-4 | 设置权限成功后 | 项目成员查看根目录权限 | 系统返回新设置的权限值 |
| AC-035-5 | 设置权限为restrict_write后 | 项目成员尝试上传文件 | 系统根据权限限制，拒绝上传操作 |

:::

#### US-036
作为一个管理者 (Administrator / Manager)，我希望能够为特定文档设置权限，从而精细化控制不同用户对不同文件的访问权限，实现细粒度的权限管理。

:::tabs
== 业务规则

- BR-036-1: 设置文档权限需要提供组织ID、项目ID、文档ID、用户ID和权限值
- BR-036-2: 文档权限会覆盖根目录的基础权限
- BR-036-3: 可以为同一文档设置多个用户的权限
- BR-036-4: 只有项目管理员可以设置文档权限
- BR-036-5: 用户必须是项目管理员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-036-1 | 用户是项目管理员，文档存在，提供有效的权限信息 | 用户设置文档权限 | 系统设置权限成功，返回成功响应 |
| AC-036-2 | 用户不是项目管理员 | 用户设置文档权限 | 系统返回权限错误 |
| AC-036-3 | 文档不存在 | 用户设置文档权限 | 系统返回错误，提示文档不存在 |
| AC-036-4 | 为同一文档设置多个用户的权限 | 用户设置文档权限 | 系统为每个用户分别设置权限成功 |
| AC-036-5 | 设置权限成功后 | 指定用户访问文档 | 系统根据设置的权限允许或拒绝访问 |

:::

#### US-037
作为一个管理者 (Administrator / Manager)，我希望能够查询文档的权限设置，从而了解当前文档的权限配置情况，便于权限审计和管理。

:::tabs
== 业务规则

- BR-037-1: 查询文档权限需要提供组织ID、项目ID和文档ID
- BR-037-2: 返回文档的所有权限配置列表，包括用户和权限值
- BR-037-3: 只有项目管理员可以查询文档权限
- BR-037-4: 返回信息包括权限配置的创建时间和更新时间
- BR-037-5: 用户必须是项目管理员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-037-1 | 用户是项目管理员，文档存在，有权限配置 | 用户查询文档权限 | 系统返回文档的所有权限配置列表 |
| AC-037-2 | 用户不是项目管理员 | 用户查询文档权限 | 系统返回权限错误 |
| AC-037-3 | 文档不存在 | 用户查询文档权限 | 系统返回错误，提示文档不存在 |
| AC-037-4 | 文档存在，但没有设置特殊权限 | 用户查询文档权限 | 系统返回空列表或提示使用根目录权限 |
| AC-037-5 | 查询成功后 | 用户查看权限详情 | 系统返回每个权限配置的详细信息，包括用户、权限值、时间等 |

:::

#### US-038
作为一个管理者 (Administrator / Manager)，我希望能够删除文档的权限设置，从而移除特定用户的访问权限，撤销授权。

:::tabs
== 业务规则

- BR-038-1: 删除文档权限需要提供组织ID、项目ID、文档ID和权限配置ID
- BR-038-2: 删除权限后，用户将使用根目录的基础权限
- BR-038-3: 只有项目管理员可以删除文档权限
- BR-038-4: 删除操作是物理删除，不可恢复
- BR-038-5: 用户必须是项目管理员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-038-1 | 用户是项目管理员，权限配置存在 | 用户删除文档权限 | 系统删除权限成功，返回成功响应 |
| AC-038-2 | 用户不是项目管理员 | 用户删除文档权限 | 系统返回权限错误 |
| AC-038-3 | 权限配置不存在 | 用户删除文档权限 | 系统返回错误，提示权限配置不存在 |
| AC-038-4 | 删除权限成功后 | 被删除权限的用户访问文档 | 系统使用根目录的基础权限进行访问控制 |
| AC-038-5 | 删除权限成功后 | 用户查询文档权限 | 系统不返回已删除的权限配置 |

:::

#### US-039
作为一个管理者 (Administrator / Manager)，我希望能够更新文档的权限设置，从而修改用户的访问权限，调整授权范围。

:::tabs
== 业务规则

- BR-039-1: 更新文档权限需要提供组织ID、项目ID、文档ID、权限配置ID和新权限值
- BR-039-2: 可以修改权限值，但不能修改关联的用户
- BR-039-3: 只有项目管理员可以更新文档权限
- BR-039-4: 更新操作会记录更新时间
- BR-039-5: 用户必须是项目管理员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-039-1 | 用户是项目管理员，权限配置存在，提供有效的新权限值 | 用户更新文档权限 | 系统更新权限成功，返回成功响应，更新时间更新 |
| AC-039-2 | 用户不是项目管理员 | 用户更新文档权限 | 系统返回权限错误 |
| AC-039-3 | 权限配置不存在 | 用户更新文档权限 | 系统返回错误，提示权限配置不存在 |
| AC-039-4 | 用户提供无效的权限值 | 用户更新文档权限 | 系统返回参数错误 |
| AC-039-5 | 更新权限成功后 | 用户查询文档权限 | 系统返回更新后的权限值 |

:::

---

## 六、轻量化转换模块

#### US-040
作为一个设计方/上传者 (Designer / Uploader)，我希望能够手动创建轻量化转换任务，从而在未开启自动转换的项目中，主动触发模型文件的轻量化转换。

:::tabs
== 业务规则

- BR-040-1: 创建转换任务需要提供组织ID、项目ID、文档ID和版本ID
- BR-040-2: 此功能针对未开启自动转换的项目
- BR-040-3: 创建任务后，转换引擎客户端会自动拾取任务
- BR-040-4: 用户必须是项目成员且项目许可证未过期
- BR-040-5: 文档必须是支持转换的模型文件格式（.rvt, .dwg, .nwd等）

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-040-1 | 用户是项目成员，文档存在，是模型文件，项目未开启自动转换 | 用户创建转换任务 | 系统创建任务成功，任务状态为待处理，返回成功响应 |
| AC-040-2 | 用户是项目成员，文档不存在 | 用户创建转换任务 | 系统返回错误，提示文档不存在 |
| AC-040-3 | 文档不是模型文件格式 | 用户创建转换任务 | 系统返回错误，提示不支持转换 |
| AC-040-4 | 项目已开启自动转换 | 用户创建转换任务 | 系统返回错误或提示无需手动创建 |
| AC-040-5 | 创建任务成功后 | 转换引擎客户端拾取任务 | 系统返回任务信息给客户端 |

:::

#### US-041
作为一个设计方/上传者 (Designer / Uploader)，我希望能够重试失败的轻量化转换任务，从而在转换出错但未达到重试阈值时，手动重新执行转换，提高转换成功率。

:::tabs
== 业务规则

- BR-041-1: 重试转换任务需要提供任务ID
- BR-041-2: 只有失败状态的任务可以重试
- BR-041-3: 重试次数未达到阈值时才能手动重试
- BR-041-4: 重试操作会将任务状态重置为待处理
- BR-041-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-041-1 | 任务存在，状态为失败，重试次数未达阈值 | 用户重试转换任务 | 系统重置任务状态为待处理，返回成功响应 |
| AC-041-2 | 任务不存在 | 用户重试转换任务 | 系统返回错误，提示任务不存在 |
| AC-041-3 | 任务状态不是失败 | 用户重试转换任务 | 系统返回错误，提示任务状态不允许重试 |
| AC-041-4 | 任务重试次数已达阈值 | 用户重试转换任务 | 系统返回错误，提示已达重试上限 |
| AC-041-5 | 重试成功后 | 转换引擎客户端拾取任务 | 系统返回任务信息给客户端，重新开始转换 |

:::

#### US-042
作为一个管理者 (Administrator / Manager)，我希望转换引擎服务账号能够从系统中拾取待处理的轻量化任务，从而获取需要转换的模型文件信息，执行转换工作。

:::tabs
== 业务规则

- BR-042-1: 拾取任务需要提供有效的Basic认证信息（客户端key和Secret）
- BR-042-2: 系统返回待处理状态的任务，如果没有则返回空
- BR-042-3: 返回的任务信息包括任务ID、文档ID、文件路径等
- BR-042-4: 拾取任务后，任务状态会更新为处理中
- BR-042-5: 多个客户端可以并发拾取不同的任务

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-042-1 | 系统中有待处理的任务，客户端提供有效的认证信息 | 客户端拾取任务 | 系统返回任务信息，任务状态更新为处理中 |
| AC-042-2 | 系统中没有待处理的任务 | 客户端拾取任务 | 系统返回空结果 |
| AC-042-3 | 客户端提供无效的认证信息 | 客户端拾取任务 | 系统返回认证错误 |
| AC-042-4 | 多个客户端同时拾取任务 | 多个客户端并发拾取任务 | 系统为每个客户端分配不同的任务 |
| AC-042-5 | 拾取任务成功后 | 客户端下载原始文件 | 系统允许客户端下载任务关联的模型文件 |

:::

#### US-043
作为一个管理者 (Administrator / Manager)，我希望转换引擎服务账号能够上报轻量化任务的转换进度，从而让用户了解转换进度，提供良好的用户体验。

:::tabs
== 业务规则

- BR-043-1: 上报进度需要提供任务ID和进度百分比
- BR-043-2: 进度值范围是0-100
- BR-043-3: 上报进度需要提供有效的Basic认证信息
- BR-043-4: 系统会记录进度上报的时间和进度值
- BR-043-5: 用户可以实时查询任务的转换进度

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-043-1 | 任务存在，客户端提供有效的认证信息和进度值 | 客户端上报进度 | 系统记录进度成功，返回成功响应 |
| AC-043-2 | 任务不存在 | 客户端上报进度 | 系统返回错误，提示任务不存在 |
| AC-043-3 | 客户端提供无效的认证信息 | 客户端上报进度 | 系统返回认证错误 |
| AC-043-4 | 进度值超出0-100范围 | 客户端上报进度 | 系统返回参数错误 |
| AC-043-5 | 上报进度成功后 | 用户查询任务进度 | 系统返回最新的进度值 |

:::

#### US-044
作为一个管理者 (Administrator / Manager)，我希望转换引擎服务账号能够上传转换完成的结果文件，从而将轻量化后的模型数据提交到系统，供用户预览使用。

:::tabs
== 业务规则

- BR-044-1: 上传转换结果需要提供任务ID、文件内容和文件路径
- BR-044-2: 上传结果需要提供有效的Basic认证信息
- BR-044-3: 上传成功后，任务状态更新为已完成
- BR-044-4: 转换结果文件存储在指定路径下
- BR-044-5: 用户可以预览转换后的模型文件

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-044-1 | 任务存在，转换完成，客户端提供有效的认证信息和结果文件 | 客户端上传转换结果 | 系统保存结果文件成功，任务状态更新为已完成，返回成功响应 |
| AC-044-2 | 任务不存在 | 客户端上传转换结果 | 系统返回错误，提示任务不存在 |
| AC-044-3 | 客户端提供无效的认证信息 | 客户端上传转换结果 | 系统返回认证错误 |
| AC-044-4 | 上传成功后 | 用户预览模型文件 | 系统返回转换后的模型资源，可以正常预览 |
| AC-044-5 | 上传文件大小超过限制 | 客户端上传转换结果 | 系统返回错误，提示文件过大 |

:::

#### US-045
作为一个管理者 (Administrator / Manager)，我希望转换引擎服务账号能够下载需要转换的原始模型文件，从而获取转换任务的源文件，执行转换处理。

:::tabs
== 业务规则

- BR-045-1: 下载原始文件需要提供任务ID和文件路径
- BR-045-2: 下载需要提供有效的Basic认证信息
- BR-045-3: 下载接口支持Range分片下载
- BR-045-4: 只有处理该任务的客户端才能下载对应的原始文件
- BR-045-5: 下载的文件是任务关联的模型文件

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-045-1 | 任务存在，客户端已拾取该任务，提供有效的认证信息 | 客户端下载原始文件 | 系统返回原始模型文件，支持Range分片下载 |
| AC-045-2 | 任务不存在 | 客户端下载原始文件 | 系统返回错误，提示任务不存在 |
| AC-045-3 | 客户端提供无效的认证信息 | 客户端下载原始文件 | 系统返回认证错误 |
| AC-045-4 | 客户端未拾取该任务 | 客户端下载原始文件 | 系统返回权限错误 |
| AC-045-5 | 请求包含Range头 | 客户端下载原始文件 | 系统返回指定范围的内容，响应状态为206 |

:::

#### US-046
作为一个管理者 (Administrator / Manager)，我希望转换引擎服务账号能够获取转换引擎的参数配置，从而了解系统对转换的要求和配置，正确执行转换任务。

:::tabs
== 业务规则

- BR-046-1: 获取参数配置需要提供组织ID和项目ID
- BR-046-2: 返回参数包括转换格式、质量设置、输出路径等配置
- BR-046-3: 参数配置可能因项目而异
- BR-046-4: 客户端应根据参数配置执行转换
- BR-046-5: 参数配置变更不影响已开始的任务

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-046-1 | 项目存在，有参数配置 | 客户端获取参数配置 | 系统返回完整的参数配置信息 |
| AC-046-2 | 项目存在，但没有特殊配置 | 客户端获取参数配置 | 系统返回默认参数配置 |
| AC-046-3 | 项目不存在 | 客户端获取参数配置 | 系统返回错误，提示项目不存在 |
| AC-046-4 | 获取参数成功后 | 客户端使用参数执行转换 | 客户端根据参数配置正确执行转换任务 |
| AC-046-5 | 参数配置更新后 | 客户端获取参数配置 | 系统返回最新的参数配置 |

:::

---

## 七、存储管理模块

#### US-047
作为一个管理者 (Administrator / Manager)，我希望能够查看项目的存储用量信息，从而了解当前项目的存储空间使用情况，合理规划存储资源。

:::tabs
== 业务规则

- BR-047-1: 查看存储用量需要提供组织ID和项目ID
- BR-047-2: 返回信息包括已用存储空间、总存储空间、使用率等
- BR-047-3: 存储用量统计包括所有档案文件的大小
- BR-047-4: 所有项目成员都可以查看存储用量
- BR-047-5: 用户必须是项目成员且项目许可证未过期

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-047-1 | 用户是项目成员，项目有文件存储 | 用户查看存储用量 | 系统返回存储用量信息，包括已用空间、总空间、使用率 |
| AC-047-2 | 用户是项目成员，项目没有文件存储 | 用户查看存储用量 | 系统返回存储用量信息，已用空间为0 |
| AC-047-3 | 用户不是项目成员 | 用户查看存储用量 | 系统返回权限错误 |
| AC-047-4 | 项目许可证已过期 | 用户查看存储用量 | 系统返回许可证过期错误 |
| AC-047-5 | 上传新文件后 | 用户查看存储用量 | 系统返回更新后的存储用量，已用空间增加 |

:::

---

## 八、文件审批模块（Review）

### P0（MVP 必做）——US-048 ~ US-061

---

#### US-048（创建文件审批 Review：选择模板+文件并生成快照）

作为一个管理者 (Administrator / Manager)，我希望能够选择 Workflow 模板与文件创建一次文件审批（Review），系统自动生成文件快照版本并立即进入流程，从而实现 WIP → Shared/Published 的合规流转闭环。

:::tabs
== 业务规则

- BR-048-1: 创建 Review 时必须保存每个文件的 `file_id + version_id + file_path` 快照信息。
- BR-048-2: Create 成功后 Review 直接为 **Open**；Initiation step 立即为 **Submitted**；下一实际审批 step 立即 **Open** 并落地 `opened_at`、`due_date`、候选者快照并发送通知。
- BR-048-3: 若用户不在模板 `allowed_initiators` 且不是 Project Admin，则禁止发起（后端强校验）。
- BR-048-4: Role 快照解析：若模板配置的 Initiator 或 Step Assignee 为 Role（角色），在 Review 创建瞬间（或 Step 开启时），系统必须将 Role 解析为具体的 User ID List 并固化为快照。
- BR-048-5: 结构不可变性：Review 创建成功后，其 Step 数量、顺序、Step Number 等结构元数据严禁修改。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-048-1 | 用户有发起权限，模板已启用，选择了多个文件 | 用户点击 Create Review | 系统创建 Review=Open；Initiation=Submitted；第一审批 step=Open；候选者立即在 My Tasks 可见 |
| AC-048-2 | 用户无发起权限且非 Project Admin | 用户尝试创建 Review | 系统拒绝并返回权限错误（不产生任何 Review 数据） |
| AC-048-3 | 创建成功 | 用户打开 Review 详情 | 文件列表展示 `version_id` 快照信息，供后续"看对版本"跳转 |
| AC-048-4 | 模板配置 Initiator 为 Role A (包含用户 U1)；Review 创建后 Role A 移除了 U1 | U1 登录系统 | U1 仍被识别为该 Review 的 Initiator（基于快照），权限不受 Role 变更影响 |
| AC-048-5 | Review 创建成功后 | 用户尝试调用 API 修改 step 数量/顺序/review_mode | 系统拒绝请求，返回 `409 WORKFLOW_STRUCTURE_IMMUTABLE`（后端安全校验） |

:::

#### US-049（Workflow 模板管理：Project Admin 强校验）

作为一个管理者 (Administrator / Manager)，我希望能够创建/修改/启用/停用 Workflow 模板，并由后端做强校验，从而保证审批流程配置安全可控。

:::tabs
== 业务规则

- BR-049-1: 只有 Project Admin 可以新建/修改/启用/停用模板；前端可隐藏入口，但后端必须强校验。
- BR-049-2: 模板基础字段：`name`（必填）、`description`、`is_enabled`、`review_step_number`（2/3/4）、`target_folder_id`、`allowed_initiators`（User/Role）、`step_config`（Review1/2/Final）、`final_labels`（自定义 label_name + decision_type，至少包含 1 个 APPROVE 与 1 个 REJECT）。
- BR-049-3: 模板 step 规则：Review1/2 支持 Single/Group；Group 需 `min_approvals`；所有 step 必填且 `due_duration_days > 0`。
- BR-049-4: 模板必须配置 `target_folder_id`，否则模板不可启用。
- BR-049-5: Create Review 时必须校验 allowed_initiators（含 Project Admin 兜底）；解析为空时拒绝发起，返回 `403 NOT_TEMPLATE_INITIATOR` 或 `409 TEMPLATE_INITIATOR_RESOLVE_EMPTY`。
- BR-049-6: Step 结构映射：系统仅允许配置 `review_step_number` 为 2、3 或 4。
  - 2 Steps: Initiation → Final
  - 3 Steps: Initiation → Review1 → Final
  - 4 Steps: Initiation → Review1 → Review2 → Final
  - 注：Initiation 永远是第一步，Final 永远是最后一步。
- BR-049-7: Final 步骤强制固定为 Single 模式。即使配置了多位候选者，任一人完成 Close 操作，step 即完成，其他候选者界面变为只读。
- BR-049-8: 模板可见性与权限：所有项目成员均可在 UI 查看“启用中”的模板列表；但如果用户不在 `allowed_initiators` 名单中，无法使用该模板创建 Review（“创建”按钮禁用）。
- BR-049-9: Label 强校验：模板的 Final Decision Labels 必须至少包含一个 APPROVE 类型和一个 REJECT 类型的选项，否则不允许保存或启用。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-049-1 | 非 Project Admin | 用户调用模板管理 API | 返回 `403 FORBIDDEN_PROJECT_ADMIN_REQUIRED` 且不产生状态变更 |
| AC-049-2 | 模板缺少 approve/reject 任一类 label | 用户启用模板 | 系统拒绝启用 |
| AC-049-3 | 模板未配置 target_folder_id | 用户启用模板 | 系统拒绝启用 |
| AC-049-4 | Group 模式且 min_approvals > 候选人数 | 用户保存/启用模板 | 系统拒绝并提示配置不合法 |
| AC-049-5 | allowed_initiators 解析为空 | 用户创建 Review | 系统返回 `403/409`，拒绝发起 |
| AC-049-6 | 用户尝试配置 Final Step 为 Group 模式 | 用户保存模板 | 系统自动修正为 Single 或报错提示"Final 仅支持 Single 语义" |
| AC-049-7 | 用户配置 Final Labels 全为 APPROVE 类型 (无 REJECT) | 用户启用模板 | 系统拒绝并提示：必须包含至少一个拒绝类选项 |
| AC-049-8 | 用户不在模板的 Initiator 白名单中 | 用户查看模板列表 | 可以看到该模板，但"创建 Review"按钮为禁用状态 |
| AC-049-9 | 用户创建模板时未填写 name | 保存模板 | 系统拒绝并提示 name 为必填项 |
| AC-049-10 | 模板配置某 step 的 due_duration_days = 0 或负数 | 保存模板 | 系统拒绝并提示 due_duration_days 必须 > 0 |
| AC-049-11 | 用户进入创建模板界面 | 用户选择步骤数 | 前端仅提供 2 步、3 步、4 步三个选项 |

:::

#### US-050（Review List & My Tasks Filter）

作为一个审阅者/协调者 (Reviewer / Coordinator)，我希望 Review 列表具备基础可见性隔离，并提供“My Tasks”筛选开关，仅展示当前待办，从而确保数据隔离与待办聚焦。

:::tabs
== 业务规则

- BR-050-1: 基础可见性 - 隔离：Admin 可见项目内所有 Review；相关人员仅可见自己是 Initiator、Owner 或历史/当前 Candidate 的 Review；无关人员列表不展示该 Review，且直接访问详情页 URL 返回 403 Forbidden。
- BR-050-2: My Tasks 筛选器：列表页提供"My Tasks"快速筛选开关（Toggle）。开启时仅展示满足以下所有条件的 Review：`Review.status = Open`、`Current_Step.status = Open`、当前用户存在于 `Current_Step.candidate_snapshot` 列表中。
- BR-050-3: 列表字段：必须展示 Review ID、标题、当前 Step 名称、Initiator、文件数量、Due Date、Overdue 标识。
- BR-050-7: Review 列表的可见性隔离必须在后端 API 层面完成（不得仅依赖前端过滤），确保安全性。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-050-1 | 用户与某 Review 完全无关（非 Admin/Initiator/Candidate） | 用户进入 Review 列表 | 列表不显示该 Review 记录 |
| AC-050-2 | 用户是某 Open Review 的当前候选人 | 用户点击"My Tasks"筛选 | 列表显示该 Review |
| AC-050-3 | 用户是某 Review 的发起人，但当前轮到别人审批 | 用户点击"My Tasks"筛选 | 该 Review 被过滤掉（不显示），但在全部列表中可见 |
| AC-050-4 | 用户与某 Review 完全无关（非 Admin/Initiator/Candidate） | 用户通过 URL 直接访问该 Review 详情页 | 系统返回 403 Forbidden（后端安全校验） |
| AC-050-5 | 用户是 Project Admin | 用户进入 Review 列表 | 列表显示项目内所有 Review（包括自己未参与的） |
| AC-050-6 | Review 列表有数据 | 用户查看列表 | 每条记录展示：Review ID、标题、当前 Step 名称、Initiator、文件数量、Due Date、Overdue 标识 |

:::

#### US-051（Step Submit：Single/Group/MinN + 幂等去重）

作为一个审阅者/协调者 (Reviewer / Coordinator)，我希望能够在当前 Open step 提交审批并自动推进到下一步（满足 Single/Group/MinN 规则），从而减少人工协调成本并保证流程一致性。

:::tabs
== 业务规则

- BR-051-1: 只有 Open step 的候选者可 Submit；非候选者提交必须拒绝。
- BR-051-2: Single：任一候选者提交即完成 step；其他候选者变只读并提示已由他人完成。
- BR-051-3: Group：distinct submitter 达 MinN 才完成 step；未达不流转。
- BR-051-4: 提交幂等：`unique(step_id, user_id)` 去重，重复提交不重复计数。
- BR-051-5: step 完成后自动打开下一步（Pending→Open），落 `due_date`、resolve 候选者快照并通知下一步候选者。
- BR-051-6: 非候选人只读：若用户有 Review 查看权限但不是"当前步骤"的候选人（例如 Initiator 查看正在审批中的节点），详情页操作区域仅展示 Timeline 和进度，不显示 Submit/Reject 按钮。
- BR-051-7: Comment 与进度：提交操作必须支持输入 Comment，并写入数据库持久化；Group 模式下，Step 详情页需展示"已提交 X / 需 N"的进度提示。
- BR-051-8: Step 变为 Open 时，系统必须解析该 step 的 assignees（含 Role 解析为 User List），写入 review_step_candidates 并落地候选者快照。
- BR-051-9: Comment 为可选字段；提交时可以不填写 Comment。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-051-1 | Single step=Open，用户为候选者 | 用户提交 | step=Submitted；若存在下一步则自动 Open 并发通知 |
| AC-051-2 | Group step=Open，MinN=3，当前已提交2人 | 第3人提交 | 第一次触发流转且只触发一次；下一步 Open |
| AC-051-3 | 用户重复点击提交 | 用户再次提交 | 不重复计数、不重复流转 |
| AC-051-4 | Group Step (MinN=3)，已提交 1 人 | 用户查看详情页 | 界面清晰显示进度 "1 / 3" 或类似进度条 |
| AC-051-5 | 用户提交审批 | 用户输入 Comment 并提交 | Comment 被保存，且后续在 Timeline 中可被完整追溯 |
| AC-051-6 | Single step=Open，候选者 A 已提交 | 其他候选者 B 访问详情页 | 界面变为只读，显示提示"该步骤已由 XXX 完成" |
| AC-051-7 | 用户是 Initiator，但不是当前 step 的候选者 | 用户访问 Review 详情页 | 仅显示 Timeline 和进度信息，不显示 Submit 按钮 |

:::

#### US-052（文件列表与跳转：必须“看得到且看对版本”）

作为一个审阅者/协调者或决策方，我希望在审批中点击文件名能打开 DMS Viewer 且锁定快照 `version_id`，并可点击路径/文件夹跳转到对应 DMS 文件夹，从而确保所有审批基于同一版本并能定位文件所在位置。

:::tabs
== 业务规则

- BR-052-1: Review 文件列表展示快照版本信息；点击文件名打开 Viewer 必须使用 `version_id` 快照。
- BR-052-2: Review 模块不扩权；文件/文件夹打开完全沿用 DMS 权限；无权限时（包括审批期间权限被移除）提示："你没有该文件或文件夹权限，请联系管理者"，且不影响页面其他信息阅读。
- BR-052-3: 点击路径或 folder icon 打开文件所在 folder。
- BR-052-4: 路径展示：文件列表需展示文件的 Breadcrumb Path（不仅是文件名），且路径节点可点击跳转到 DMS Folder。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-052-1 | Review 中某文件快照 version_id=v1 | 用户点击文件名 | Viewer 打开版本=v1（与快照一致） |
| AC-052-2 | DMS 返回无权限 | 用户点击文件或文件夹 | 页面提示统一文案，其它审批信息仍可阅读 |
| AC-052-3 | Review 中某文件 | 用户点击路径或 folder icon | 打开文件所在 folder |
| AC-052-4 | 用户是候选者，但在审批期间被 DMS 移除了文件权限 | 用户点击文件名 | 系统拦截并弹出统一“无权限”提示（不崩溃） |

:::

#### US-053（Final 决策：每文件必选 label，否则不可 Close）

作为一个决策方 (Decision Maker)，我希望在 Final 步骤对每个文件选择审批结论（Approve/Reject label），从而确保最终结案有完整可追溯的决策记录。

:::tabs
== 业务规则

- BR-053-1: Final 必须对每个文件选择一个 label，并保存 `label_name + decision_type`。
- BR-053-2: 若存在未决策文件，则不可 Close，返回 `409 FINAL_DECISIONS_INCOMPLETE`。
- BR-053-3: Final 步骤固定为 Single 模式。即使模板配置了多位候选者，任一候选者完成 Close 操作后，其他候选者界面立即变为只读。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-053-1 | Final 页面存在 N 个文件 | 用户为每个文件选择 label 并保存 | 系统保存成功 |
| AC-053-2 | 有任一文件未选 label | 用户尝试 Close | 系统拒绝 Close 并提示未选清单 |

:::

#### US-054（Final Step 自动 Close：校验完整性与 Target Folder，自动复制 APPROVE 文件）

作为一个决策方 (Decision Maker)，我希望在 Final 步骤提交后，系统自动检测所有文件是否已决策、Target Folder 是否可访问，满足条件时自动 Close Review 并复制 APPROVE 文件到 Target Folder，从而实现审批闭环与合规发布的自动化。

:::tabs
== 业务规则

- BR-054-1: Final Step 候选者提交时，系统自动检测：(1) 所有文件是否已完成 Final 决策；(2) Target Folder 是否可访问。
- BR-054-2: 若检测通过，系统自动执行：(1) `Review.status → Closed`；(2) 遍历 `review_file_snapshot`，仅 `decision_type=APPROVE` 的文件复制到 `review.target_folder_id`；(3) 每文件写入 `copy_result`（SUCCESS/FAIL/SKIPPED + reason）。
- BR-054-3: 若检测不通过（文件未全部决策或 Target Folder 不可访问），Review 保持 Open 状态，不执行 Close 和 Copy。
- BR-054-4: REJECT 文件标记为 SKIPPED，不复制；允许部分文件复制失败，Close 不回滚。
- BR-054-5: Closed/Void 为终态，只读并阻断所有推进型操作（Submit/Save Final 等）。
- BR-054-6: APPROVE 文件复制后在 Target Folder 中应与审批快照版本一致（使用 `version_id`）。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-054-1 | Final 决策完整且 Target Folder 可访问 | Final Step 候选者提交 | Review 自动变为 Closed，APPROVE 文件自动复制到 Target Folder |
| AC-054-2 | Final 决策未完整 | Final Step 候选者提交 | Review 保持 Open，不执行 Close 和 Copy |
| AC-054-3 | Target Folder 不存在或不可访问 | Final Step 候选者提交 | Review 保持 Open，不执行 Close 和 Copy |
| AC-054-4 | 混合 approve/reject 文件，Final 决策完整且 Target Folder 可访问 | Final Step 候选者提交 | approve 文件被复制；reject 文件标记 SKIPPED |
| AC-054-5 | 复制中部分文件失败 | Final Step 提交触发自动 Close | Review 仍保持 Closed；失败文件记录 FAIL+reason |
| AC-054-6 | Review 状态为 Closed | 候选者尝试调用 Submit API | 系统返回 `409 REVIEW_NOT_OPEN`（后端安全校验） |
| AC-054-7 | Review 状态为 Closed | 用户尝试调用 Save Final Decisions API | 系统返回 `409 REVIEW_NOT_OPEN`（后端安全校验） |
| AC-054-8 | APPROVE 文件复制成功 | 管理员查询 Target Folder 中复制的文件版本 | 文件版本与 Review 快照的 version_id 一致 |

:::

#### US-055（通知：创建/推进/关闭/逾期）

作为一个管理者 (Administrator / Manager) 或审阅者/协调者 (Reviewer / Coordinator)，我希望系统在关键节点发送通知，收件人与候选者快照一致，并对逾期做去重提醒，从而保障流程的可见性与催办效率。

:::tabs
== 业务规则

- BR-055-1: 通知触发矩阵至少包含 Review Created、Step Advanced、Review Closed、Step Overdue。
- BR-055-2: 通知收件人中的 Role 必须解析为具体用户的 email 或系统账号，与候选者快照一致。
- BR-055-3: Overdue 通知去重，同一步每日最多一封。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-055-1 | Step 进入 Open | 系统发送通知 | 收件人与候选者快照一致 |
| AC-055-2 | Step N Submitted → Step N+1 Open | 系统发送通知 | 下一步候选者收到通知 |
| AC-055-3 | Step 逾期且当日未通知 | 每日扫描任务运行 | 发送 Overdue 且记录去重 |
| AC-055-4 | Review 创建成功 | 系统发送 Review Created 通知 | 第一步候选者收到通知 |
| AC-055-5 | Review Close 成功 | 系统发送 Review Closed 通知 | Initiator 和相关参与者收到通知 |

:::

#### US-056（Due/Overdue：标识与扫描）

作为一个管理者 (Administrator / Manager) 或审阅者/协调者 (Reviewer / Coordinator)，我希望前端清晰标识 Overdue，后端每日扫描并发送去重提醒，从而及时催办。

:::tabs
== 业务规则

- BR-057-1: 前端 Overdue 显示规则：`today > due_date`。
- BR-057-2: 后端每日扫描 Open steps，逾期且当日未通知则发送 Overdue，并记录 `last_overdue_notified_at` 去重。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-057-1 | step=Open，today > due_date | 前端显示 | 标识 Overdue |
| AC-057-2 | step 逾期且当日未通知 | 每日扫描任务运行 | 发送 Overdue 并记录去重字段 |

:::

#### US-058（事件日志与 Timeline）

作为一个管理者 (Administrator / Manager) 或审阅者/协调者 (Reviewer / Coordinator)，我希望在事件日志与 Timeline 中清晰追溯每一步的操作者、时间、评论与版本状态，从而便于审计与回溯。

:::tabs
== 业务规则

- BR-058-1: 事件日志至少记录 REVIEW_CREATED/STEP_OPENED/STEP_SUBMITTED/FINAL_DECISION_SAVED/REVIEW_CLOSED/REVIEW_VOIDED/COPY_RESULT_WRITTEN/REVIEW_ARCHIVED。
- BR-058-2: Timeline 展示 Step 聚合信息（opened_at、submitted_at、提交者、comment）及事件流，按时间倒序。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-058-1 | 任一关键事件发生 | 用户查看 Timeline | 能看到事件、操作者、时间、comment，按时间倒序 |
| AC-058-2 | Group Step 多人提交 | 用户查看 Timeline | 显示所有提交者与各自 comment |
| AC-058-3 | 完整的 Review 生命周期（创建→审批→关闭） | 管理员查看事件日志 | 日志包含所有 8 种事件类型：REVIEW_CREATED、STEP_OPENED、STEP_SUBMITTED、FINAL_DECISION_SAVED、REVIEW_CLOSED、REVIEW_VOIDED、COPY_RESULT_WRITTEN、REVIEW_ARCHIVED |

:::

#### US-059（终态与作废：Closed/Void 阻断）

作为一个管理者 (Administrator / Manager)，我希望在必要时作废进行中的 Review，并确保 Closed/Void 终态阻断所有推进型操作，从而保证流程安全可控。

:::tabs
== 业务规则

- BR-059-1: 仅 Project Admin 可作废 Review；仅 status=Open 时允许作废。
- BR-059-2: 作废成功后 Review.status → Void；Closed/Void 为终态，不再允许 Submit/Save Final/Close 等推进型操作，相关 API 返回 `409 REVIEW_NOT_OPEN`。
- BR-059-3: Closed/Void 的 Review 不在 My Tasks 中展示，前端只读。
- BR-059-4: 终态数据不可变：当 Review 处于 Closed 或 Void 状态时，严禁修改任何业务元数据，包括：Target Folder、文件清单、Decision 结果、版本快照等。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-059-1 | Review=Open，操作者为 Project Admin | 用户作废 | Review.status=Void，所有推进型操作被阻断 |
| AC-059-2 | Review=Closed/Void 或操作者无权限 | 用户作废 | 系统拒绝并返回权限/状态错误 |
| AC-059-3 | Review=Void | 用户访问 My Tasks/推进 API | 任务不展示；推进 API 返回 `409 REVIEW_NOT_OPEN` |
| AC-059-4 | Review = Closed | 用户尝试调用 API 修改 Target Folder | 系统拒绝请求 (409 Conflict)，前端编辑入口隐藏或禁用 |
| AC-059-5 | Review 状态为 Closed 或 Void | 用户访问详情页 | 前端所有编辑类操作入口禁用或隐藏（如 Submit、Save Decision、Close 等按钮） |
| AC-059-6 | Review 状态为 Closed | 用户尝试调用修改类 API（修改文件清单/Decision 结果/版本快照） | 系统拒绝请求，返回 `409 Conflict`（后端安全校验） |

:::

#### US-060（步骤状态机与到期规则：Pending→Open→Submitted + due 计算）

作为一个管理者 (Administrator / Manager) 或审阅者/协调者 (Reviewer / Coordinator)，我希望步骤生命周期和到期规则明确且不可被绕过，从而保证流程节奏与审计一致性。

:::tabs
== 业务规则

- BR-060-1: 步骤状态仅有 Pending→Open→Submitted，任一时刻仅允许 1 个 step 为 Open。
- BR-060-2: step 变为 Open 当下计算 `due_date = opened_at + due_duration_days`（日历日）；不提供修改 due_date 的能力。
- BR-060-3: 非 Open step 不可提交，提交返回 `409 STEP_NOT_OPEN`。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-060-1 | 新的 step 被打开 | 系统计算 due_date | due_date = opened_at + 配置的 due_duration_days，且不可编辑 |
| AC-060-2 | 同一 Review 存在一个 Open step | 系统检查 | 不存在第二个 Open step |
| AC-060-3 | step 为 Pending/Submitted | 用户尝试提交 | 系统返回 `409 STEP_NOT_OPEN` |

:::

#### US-061（查询 Review 权限：前端权限控制辅助接口）

作为一个审阅者/协调者 (Reviewer / Coordinator) 或管理者 (Administrator / Manager)，我希望能查询我对某个 Review 的操作权限，从而前端可以根据权限显示或隐藏操作按钮，提供更好的用户体验。

:::tabs
== 业务规则

- BR-061-1: 查询权限接口返回用户对该 Review 的所有操作权限标识（canSubmit、canDecide、canVoid、canView）。Close 操作已集成到 Final Step Submit 中，无需单独权限。
- BR-061-2: 权限计算逻辑在后端统一实现，避免前端重复实现复杂的权限判断逻辑。
- BR-061-3: 只有有权限访问该 Review 的用户才能查询权限（Admin、Initiator、Owner、Candidate）。
- BR-061-4: 返回信息包含当前步骤ID、用户角色标识（isCandidate、isInitiator、isAdmin）。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-061-1 | 用户有访问权限，Review 状态为 Open，用户是当前步骤候选者 | 用户查询权限 | 系统返回 canSubmit=true，canView=true，其他权限根据实际情况返回 |
| AC-061-2 | 用户有访问权限，当前步骤为 Final，用户是候选者 | 用户查询权限 | 系统返回 canDecide=true，canSubmit=true（Final Step 提交时自动 Close） |
| AC-061-3 | 用户是 Project Admin，Review 状态为 Open | 用户查询权限 | 系统返回 canVoid=true，isAdmin=true |
| AC-061-4 | 用户无访问权限 | 用户查询权限 | 系统返回 403 权限错误 |
| AC-061-5 | 前端根据返回的权限标识 | 前端渲染页面 | 显示或隐藏对应的操作按钮（Submit、Close、Void等） |

:::

### P1（有时间可做 / 影响运营效率）——US-062 ~ US-064

（P1：归档/导出/Review Chain）

#### US-062（归档 Review：不改变 status，仅影响列表可见）

作为一个管理者 (Administrator / Manager)，我希望能将 Closed/Void 的 Review 归档，从而保持主列表干净并便于治理。

:::tabs
== 业务规则

- BR-062-1: 仅 Project Admin 可归档；仅 status=Closed 或 Void 的 Review 可归档。
- BR-062-2: 归档后写入 `archived_at`、`archived_by_user_id`，主列表默认隐藏该 Review；归档列表可见。
- BR-062-3: 归档不改变 Review.status（仍为 Closed/Void）；归档需记录 REVIEW_ARCHIVED 事件。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-062-1 | Review=Closed/Void，操作者为 Project Admin | 用户归档 | Review 在主列表隐藏，归档列表可见，写入归档时间/人 |
| AC-062-2 | Review=Open 或操作者无权限 | 用户归档 | 系统拒绝归档，返回错误 |
| AC-062-3 | 归档成功 | 用户查看 Timeline/事件流 | 能看到 REVIEW_ARCHIVED 记录 |

:::

#### US-063（导出审批报告：Excel，含可点击 deep link）

作为一个管理者 (Administrator / Manager)，我希望能导出单个 Review 的审批报告（Excel），从而用于周报/月报与合规留痕。

:::tabs
== 业务规则

- BR-063-1: 仅有权限查看该 Review 的用户可导出报告；报告内容包含文件列表、快照 version_id、每文件决策、提交人、时间轴、Overdue 状态。
- BR-063-2: 报告中的文件/Review/Chain 链接使用可点击 deep link（携带 review_id、file_id、version_id）。
- BR-063-3: 不支持 Open/作废中的空决策导出为最终结论；缺决策文件需在报告中标记未完成。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-063-1 | 用户有查看权限，Review=Closed 或 Open | 用户导出报告 | 生成 Excel，含文件/决策/时间轴信息与 deep link |
| AC-063-2 | 用户无查看权限 | 用户导出报告 | 系统拒绝导出，返回权限错误 |
| AC-063-3 | 部分文件未决策 | 用户导出报告 | 报告中标记未决策项，不生成虚假结论 |

:::

#### US-064（关联 Review / Review Chain：重送与链条管理）

作为一个管理者 (Administrator / Manager)，我希望能基于历史 Closed Review 创建重送并形成 Review Chain，从而减少重复配置、提升返工效率。

:::tabs
== 业务规则

- BR-064-1: 仅基于已 Closed 的 Review 可创建重送；新 Review 挂载 chain_id、round_no、related_review_id 快照。
- BR-064-2: Chain 级展示包含 round 与成员列表；重送时可选择上一轮文件/决策摘要供参考，不自动继承决策。
- BR-064-3: Chain 对列表可见性不变；各成员 Review 独立状态。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-064-1 | 选定 Closed 的 Review | 用户创建重送 | 新 Review 生成并携带 chain_id、round_no、自增轮次 |
| AC-064-2 | 尝试基于非 Closed Review | 用户创建重送 | 系统拒绝并提示仅支持 Closed |
| AC-064-3 | Chain 中存在多轮 | 用户查看链路 | 能看到按 round 的关联关系和各轮状态 |

:::

### P2（下版本迭代 / 高复杂度或纠错增强）——US-065 ~ US-066

（P2：严格接手/退回上一步）

#### US-065（严格接手追踪：Start/Owner 门槛）

作为一个管理者 (Administrator / Manager) 或审阅者/协调者 (Reviewer / Coordinator)，我希望启用严格接手追踪（Start 后才可 Submit，MinN=1 有 Owner），从而提升责任可追踪性。

:::tabs
== 业务规则

- BR-064-1: 严格模式下，候选者需先执行 Start 才能 Submit。
- BR-064-2: MinN=1 时第一位 Start 的人成为唯一 Owner，其他候选者 Start 被拒绝；MinN>1 时允许并行 Start。
- BR-064-3: Start/Submit 仍受 Step Open 状态限制；数据记录 `review_step_participant`，唯一约束 `unique(step_id, user_id)`；Owner 字段写入 `review_step.owner_user_id`。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-064-1 | 严格模式，step=Open，用户未 Start | 用户直接 Submit | 系统拒绝，提示需先 Start |
| AC-064-2 | MinN=1，候选者 A 先 Start | 候选者 B Start | 系统拒绝，提示已被占用 |
| AC-064-3 | MinN>1，多个候选者已 Start 未达 MinN | 一名候选者 Submit | 未达 MinN 不流转，达到 MinN 时只流转一次 |

:::

#### US-066（流程纠错：退回上一步）

作为一个管理者 (Administrator / Manager) 或审阅者/协调者 (Reviewer / Coordinator)，我希望能将流程从当前 step 退回上一步并清空提交、重算 due、记日志并通知，从而支持漏审/补审的纠错场景。

:::tabs
== 业务规则

- BR-066-1: 仅 Review.status=Open 且当前存在 Open step 时允许退回，且当前 step 不是首个 step。
- BR-066-2: 只有管理者或具备 Workflow 管理权限的审阅者/协调者可执行退回；其他用户仅可查看只读提示。
- BR-066-3: 退回后：当前 Open step → Pending（清空提交记录），上一 step → Open，重新落地 `opened_at`、`due_date`，重新 resolve 候选者快照并发通知。
- BR-066-4: 退回不允许保留原提交计数，避免 MinN 失真；必须重算 due。

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-066-1 | Review=Open，当前 step 非首步，操作者有权限 | 用户执行退回 | 当前 step 提交记录清空；上一 step 变为 Open 并重新计算 due_date、发通知 |
| AC-066-2 | 当前 step 为首步 或 Review 非 Open | 用户执行退回 | 系统拒绝退回，返回错误 |
| AC-066-3 | 无权限用户 | 用户执行退回 | 系统拒绝并提示无权限 |

:::

### 文件审批优先级表格（功能点 ↔ 用户故事 ↔ 优先级）

| 功能点（PRD） | 优先级 | 对应用户故事 |
| --- | --- | --- |
| Workflow 模板（Project Admin） | P0 | US-049 |
| Create Review | P0 | US-048 |
| Review List & My Tasks Filter | P0 | US-050 |
| Step 状态机与到期规则 | P0 | US-060 |
| 终态/Void 阻断 | P0 | US-059 |
| 审批执行（Submit/MinN/幂等） | P0 | US-051 |
| 文件列表与跳转（version_id 快照） | P0 | US-052 |
| Final Review（每文件必选） | P0 | US-053 |
| Final Step 自动 Close + 自动 Copy | P0 | US-054 |
| 通知（Created/Advance/Closed/Overdue） | P0 | US-055 |
| Due/Overdue 扫描与标识 | P0 | US-056 |
| 活动日志与 Timeline | P0 | US-057 |
| 终态/Void 阻断 | P0 | US-058 |
| Step 状态机与到期规则 | P0 | US-059 |
| 查询 Review 权限（辅助接口） | P0 | US-060 |
| 归档 | P1 | US-061 |
| 导出报告 | P1 | US-062 |
| Review Chain/关联重送 | P1 | US-063 |
| 严格接手追踪 | P2 | US-064 |
| 退回上一步 | P2 | US-065 |

---

## 九、文件传输模块（Transmittal）

#### US-067（创建并发送 Transmittal：信息填写 + 文件快照）
作为一个设计方/上传者 (Designer / Uploader)，我希望能够创建并发送 Transmittal，填写标题/收件人/消息并从 DMS 选择文件（支持多选/文件夹），系统冻结文件版本快照，从而形成正式、可追溯的文件交付记录并为 Review 提供输入。

:::tabs
== 业务规则

- BR-067-1: Title 必填，纯文本，长度不超过 100 字符
- BR-067-2: Recipients 必填，支持多选 User/Role；Role 在发送时解析为用户列表并固化快照；收件人过长时 UI 支持「User A, User B +N others」摘要展示
- BR-067-3: Message 选填，支持多行文本或简易格式，长度不超过 2000 字符
- BR-067-4: 文件必须从当前项目 DMS 中选择，支持跨文件夹多选与文件夹选择；发送时记录 `file_id + version_id + file_path` 快照
- BR-067-5: 选择文件夹时需在发送时展开并固化文件清单与路径；后续 DMS 移除/移走/新增不影响本次 Transmittal
- BR-067-6: Transmittal 文件清单仅展示文件，不展示文件夹节点
- BR-067-7: 仅可选择当前用户在 DMS 中有权限的文件/文件夹，权限校验逻辑与 DMS 保持一致
- BR-067-8: Transmittal 发出后内容不可修改或删除（标题、收件人、消息、文件列表与版本快照）

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-067-1 | 未填写 Title 或未选择 Recipients | 用户点击发送 | 发送按钮禁用或提示必填错误 |
| AC-067-2 | Recipients 中包含 Role | 用户发送 Transmittal | 系统解析 Role 下用户并固化为收件人快照 |
| AC-067-3 | 选择 DMS 文件并发送 | 用户查看详情 | 文件列表显示发送时的 `version_id`，后续 DMS 版本更新不影响该 Transmittal |
| AC-067-4 | Message 为空 | 用户发送 Transmittal | 发送成功，消息字段为空但不报错 |
| AC-067-5 | Transmittal 已发送 | 用户尝试修改标题/文件列表 | 系统拒绝修改并返回错误 |
| AC-067-6 | 用户选择无权限的文件或文件夹 | 用户发送 Transmittal | 系统拒绝并提示无权限 |
| AC-067-7 | 选择文件夹发送后文件被移除/移走/新增 | 用户查看详情或下载 | 仍以创建时快照为准 |

:::

#### US-068（Transmittal 列表与可见性隔离）
作为一个审阅者/协调者 (Reviewer / Coordinator) 或管理者 (Administrator / Manager)，我希望能够在列表中查看与我相关的 Transmittal，并按权限隔离显示，从而快速跟踪接收状态与历史记录。

:::tabs
== 业务规则

- BR-068-1: 列表字段包含：ID、Title、Sender、Recipients 概要、Create Date、Status（当前用户状态）
- BR-068-2: 列表默认按创建时间倒序排序
- BR-068-3: 可见性隔离：PM 可见项目内所有 Transmittal；发件人可见自己发出的；收件人（或其 Role 被列入）可见相关 Transmittal
- BR-068-4: Role 解析以发送时快照为准，角色后续变更不影响已发送记录的可见性
- BR-068-5: 列表权限必须在后端强校验，防止 IDOR 访问未授权记录
- BR-068-6: 列表加载性能目标：2 秒内返回数据

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-068-1 | 用户为 PM | 用户进入列表 | 列表显示项目内全部 Transmittal |
| AC-068-2 | 用户为发件人 | 用户进入列表 | 仅看到自己发出的 Transmittal |
| AC-068-3 | 用户为收件人或在 Role 快照中 | 用户进入列表 | 列表显示与用户相关的 Transmittal |
| AC-068-4 | 列表存在多条记录 | 用户进入列表 | 默认按创建时间倒序显示 |
| AC-068-5 | 标题超长 | 用户查看列表 | 标题被截断显示且支持 Tooltip 查看完整标题 |
| AC-068-6 | 列表有数据 | 用户请求列表 | 2 秒内返回结果 |

:::

#### US-069（Transmittal 详情与文件跳转）
作为一个审阅者/协调者 (Reviewer / Coordinator) 或管理者 (Administrator / Manager)，我希望在 Transmittal 详情页查看发文信息与文件清单，并能跳转到 Viewer 或 DMS 文件夹，从而确保基于发送时版本进行审阅。

:::tabs
== 业务规则

- BR-069-1: 详情页顶部展示 Title、ID、Sender、Message、Create Date
- BR-069-2: 文件清单展示 File Name、DMS Path、Version（发送时快照）
- BR-069-3: 点击文件名在新标签页打开 Viewer，必须使用快照 `version_id`
- BR-069-4: 点击路径或文件夹图标跳转到 DMS 文件夹；若原文件已删除，系统需友好提示并保留记录
- BR-069-5: Viewer 与 Folder 跳转需沿用 DMS 权限；无权限提示但不影响详情页其它信息阅读
- BR-069-6: 详情页访问需后端权限校验，未授权用户返回 403 Forbidden

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-069-1 | Transmittal 已创建 | 用户查看详情 | 顶部信息与创建时一致 |
| AC-069-2 | 详情页文件列表存在 | 用户点击文件名 | Viewer 打开且版本为发送时快照 `version_id` |
| AC-069-3 | 详情页路径可点击 | 用户点击路径或文件夹图标 | 跳转到对应 DMS 文件夹层级 |
| AC-069-4 | 原文件被删除 | 用户点击文件名或路径 | 系统提示文件不可访问但详情页仍可查看 |
| AC-069-5 | 用户无访问权限 | 用户通过 URL 访问详情 | 系统返回 403 Forbidden |
| AC-069-6 | 用户无 DMS 文件权限 | 用户点击文件名或路径 | 系统提示无权限且详情页其它信息可查看 |

:::

#### US-070（打包下载：Download All）
作为一个审阅者/协调者 (Reviewer / Coordinator)，我希望能够一键打包下载 Transmittal 中的所有文件，从而离线查看与保存。

:::tabs
== 业务规则

- BR-070-1: 详情页提供「Download All」按钮，打包下载清单内所有文件的快照版本
- BR-070-2: Zip 包内文件名保持原文件名
- BR-070-3: 50 个文件打包下载需在 30 秒内开始响应（允许异步处理）
- BR-070-4: 点击 Download All 后，当前用户状态更新为 `Downloaded`
- BR-070-5: 所有收件人均可下载本附函内文件，不受 DMS 文件/文件夹权限限制
- BR-070-6: 即使 DMS 中文件被删除/移走或新增，Transmittal 仍可打包下载（基于创建快照）

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-070-1 | Transmittal 包含多个文件 | 用户点击 Download All | 下载的 Zip 解压后文件数量与内容与清单一致 |
| AC-070-2 | Zip 包内文件 | 用户解压 | 文件名与原文件一致 |
| AC-070-3 | Transmittal 含 50 个文件 | 用户点击 Download All | 30 秒内开始响应下载 |
| AC-070-4 | 用户完成下载 | 用户查看状态 | 当前用户状态变为 `Downloaded` |
| AC-070-5 | 用户为收件人但无 DMS 文件权限 | 用户点击 Download All | 仍可正常下载 |
| AC-070-6 | DMS 中文件被删除/移走/新增 | 用户点击 Download All | 仍可正常下载 |

:::

#### US-071（收件人状态自动变更：Received / Viewed / Downloaded）
作为一个管理者 (Administrator / Manager) 或收件人，我希望系统能自动更新每个收件人的接收状态，从而追踪交付进度。

:::tabs
== 业务规则

- BR-071-1: Transmittal 创建成功时，收件人初始状态为 `Received`
- BR-071-2: 收件人进入详情页时，`Received` → `Viewed`；若已为 `Downloaded` 则保持不变
- BR-071-3: 收件人打包下载时，状态更新为 `Downloaded`（最高优先级）
- BR-071-4: 状态为每用户独立，不相互影响
- BR-071-5: 列表与详情页应展示当前用户状态

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-071-1 | Transmittal 创建成功 | 收件人查看状态 | 初始状态为 `Received` |
| AC-071-2 | 收件人进入详情页 | 用户刷新列表或详情 | 状态变为 `Viewed` |
| AC-071-3 | 收件人执行下载 | 用户查看状态 | 状态变为 `Downloaded` |
| AC-071-4 | 用户 A 进入详情页 | 用户 B 未操作 | 用户 B 状态仍为 `Received` |
| AC-071-5 | 状态已为 `Downloaded` | 用户再次查看详情 | 状态保持 `Downloaded` |

:::

#### US-072（活动日志：审计追踪）
作为一个管理者 (Administrator / Manager) 或收件人，我希望能够查看 Transmittal 活动日志，记录谁在什么时候创建、查看、下载，从而满足审计需求。

:::tabs
== 业务规则

- BR-072-1: 活动日志展示位置在详情页侧栏或 Tab
- BR-072-2: 日志包含 User Name、Action、Timestamp（精确到秒）
- BR-072-3: 必须记录事件：`Transmittal Created`、`User Viewed Transmittal`、`User Downloaded Attachments`
- BR-072-4: 日志更新可即时或刷新后可见
- BR-072-5: 仅有权限访问该 Transmittal 的用户可查看日志

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-072-1 | Transmittal 创建成功 | 用户查看日志 | 出现 `Transmittal Created` 记录 |
| AC-072-2 | 用户进入详情页 | 用户查看日志 | 出现 `User Viewed Transmittal` 记录 |
| AC-072-3 | 用户下载附件 | 用户查看日志 | 出现 `User Downloaded Attachments` 记录 |
| AC-072-4 | 任一事件发生 | 用户查看日志 | 时间戳精确到秒 |
| AC-072-5 | 用户无权限 | 用户访问日志 | 系统返回 403 Forbidden |

:::

#### US-073（邮件通知：创建后一次性发送）
作为一个收件人或管理者，我希望在 Transmittal 创建成功后收到邮件通知，从而及时获知新的文件交付。

:::tabs
== 业务规则

- BR-073-1: 仅在 Transmittal 创建成功并写入数据库后触发一次通知；状态变更不发送邮件
- BR-073-2: 收件对象为 Recipients 中的用户与 Role 解析后的用户邮箱
- BR-073-3: 邮件 Subject 模板为 `[Transmittal Notification] New Transmittal Received: {Transmittal ID} - {Title}`
- BR-073-4: 邮件 Body 包含 Sender Name、Title、Create Date、Message 内容
- BR-073-5: Message 为空时可留空展示，不影响发送

== 验收标准

| AC ID | Given | When | Then |
| --- | --- | --- | --- |
| AC-073-1 | Transmittal 创建成功 | 系统发送通知 | 所有收件人收到邮件 |
| AC-073-2 | Transmittal 状态变更 | 系统触发通知 | 不发送邮件 |
| AC-073-3 | Recipients 包含 Role | 系统发送通知 | Role 解析出的用户收到邮件 |
| AC-073-4 | 邮件送达 | 用户查看邮件 | Subject 与 Body 内容符合模板 |
| AC-073-5 | Transmittal 创建失败 | 系统处理 | 不发送邮件 |

:::

---

## 用户故事统计

- **总计用户故事数量**: 73条
- **覆盖接口数量**: 67个接口（含文件传输模块接口）
- **涉及用户角色**: 4个核心业务角色（含技术支撑角色）
- **功能模块**: 9个核心模块

## 用户故事与接口映射关系

| 用户故事ID | 接口名称 | 接口路径 | 备注 |
| :--- | :--- | :--- | :--- |
| [US-001](#us-001) | [创建上传任务](../技术实现/API/文档管理接口文档.md#创建上传任务) | `POST /doc/upload/task` | 创建任务后才能进行分片上传，单个文件最大支持5G，返回任务ID需客户端记录 |
| [US-002](#us-002) | [分片上传](../技术实现/API/文档管理接口文档.md#分片上传) | `POST /doc/upload/chunk` | 每片大小不超过20M，建议10M，支持断点续传 |
| [US-003](#us-003) | [合并分片文件成档案](../技术实现/API/文档管理接口文档.md#合并分片文件成档案) | `POST /doc/chunk/merge` | 合并所有分片成完整档案，合并失败保留已上传分片 |
| [US-004](#us-004) | [校验上传文件名](../技术实现/API/文档管理接口文档.md#校验上传文件名) | `GET /doc/check-file-name` | 检查目标位置是否存在同名文件，返回同名文件ID或null |
| [US-005](#us-005) | [创建文件夹](../技术实现/API/文档管理接口文档.md#创建文件夹) | `POST /doc/folder` | 创建文件夹用于组织文件，记录操作日志 |
| [US-006](#us-006) | [档案重命名](../技术实现/API/文档管理接口文档.md#档案重命名) | `PUT /doc/rename` | 重命名档案或文件夹，更新档案更新时间 |
| [US-007](#us-007) | [复制档案](../技术实现/API/文档管理接口文档.md#复制档案) | `POST /doc/copy` | 复制档案到其他位置，文件夹会递归复制所有内容 |
| [US-008](#us-008) | [移动档案](../技术实现/API/文档管理接口文档.md#移动档案) | `POST /doc/move` | 移动档案到其他文件夹，文件夹会递归移动所有内容 |
| [US-009](#us-009) | [档案移入回收站](../技术实现/API/文档管理接口文档.md#档案移入回收站) | `DELETE /doc` | 将档案移入回收站，文件夹下所有档案都会被移除 |
| [US-010](#us-010) | [搜索档案](../技术实现/API/文档管理接口文档.md#搜索档案) | `GET /doc/search` | 支持按名称搜索，支持按更新时间、名称、大小排序，支持分页 |
| [US-011](#us-011) | [获取档案信息](../技术实现/API/文档管理接口文档.md#获取档案信息) | `GET /doc/info` | 获取档案详细信息，包括版本、大小、创建时间等元数据 |
| [US-012](#us-012) | [根据档案ID查询文件树](../技术实现/API/文档管理接口文档.md#根据档案id查询文件树) | `POST /doc/subtree` | 根据档案ID查询文件树结构，包含文件夹层级和子文件列表 |
| [US-013](#us-013) | [获取档案面包屑](../技术实现/API/文档管理接口文档.md#获取档案面包屑) | `GET /doc/breadcrumbs` | 获取从根目录到当前档案的完整导航路径 |
| [US-014](#us-014) | [预览档案](../技术实现/API/文档管理接口文档.md#预览档案) | `GET /doc/preview` | 支持图片、视频、音频及文档(office、pdf)，支持Range分片 |
| [US-015](#us-015) | [下载档案](../技术实现/API/文档管理接口文档.md#下载档案) | `GET /doc/download` | 只支持文件类型，支持Range分片下载，设置Content-Disposition头 |
| [US-016](#us-016) | [预览模型文件](../技术实现/API/文档管理接口文档.md#预览模型文件) | `GET /doc/resource` | 预览轻量化后的3D模型，支持Range分片，需模型已完成转换 |
| [US-017](#us-017) | [预览模型文件（分享）](../技术实现/API/文档管理接口文档.md#预览模型文件分享) | `GET /doc/resource/share` | 免登录访问接口，允许未登录用户通过分享链接预览模型 |
| [US-018](#us-018) | [获取档案版本列表](../技术实现/API/文档管理接口文档.md#获取档案版本列表) | `GET /doc/version/list` | 获取档案的所有版本列表，按版本号或创建时间排序 |
| [US-019](#us-019) | [创建模型批注](../技术实现/API/批注接口文档.md#创建模型批注) | `POST /annotation` | 在模型上创建批注，记录视点坐标和描述信息，记录操作日志 |
| [US-020](#us-020) | [更新模型批注](../技术实现/API/批注接口文档.md#更新模型批注) | `PUT /annotation` | 更新批注内容或视点坐标，记录操作日志 |
| [US-021](#us-021) | [删除批注](../技术实现/API/批注接口文档.md#删除批注) | `DELETE /annotation` | 删除批注，物理删除不可恢复，记录操作日志 |
| [US-022](#us-022) | [获取模型批注列表](../技术实现/API/批注接口文档.md#获取模型批注列表) | `GET /annotation/list` | 查询模型的所有批注列表，支持分页 |
| [US-023](#us-023) | [获取模型批注详情](../技术实现/API/批注接口文档.md#获取模型批注详情) | `GET /annotation/detail` | 获取批注的详细信息，包括内容、位置、创建者等 |
| [US-024](#us-024) | [创建问题](../技术实现/API/问题管理接口文档.md#创建问题) | `POST /issue` | 创建问题工单，记录设计问题并指派责任人，记录操作日志 |
| [US-025](#us-025) | [修改问题](../技术实现/API/问题管理接口文档.md#修改问题) | `PUT /issue` | 更新问题描述、状态或责任人，跟踪问题处理进度 |
| [US-026](#us-026) | [删除问题](../技术实现/API/问题管理接口文档.md#删除问题) | `DELETE /issue` | 删除问题工单，物理删除不可恢复，记录操作日志 |
| [US-027](#us-027) | [获取问题管理列表](../技术实现/API/问题管理接口文档.md#获取问题管理列表) | `GET /issue/list` | 查询问题工单列表，支持按状态、责任人等条件筛选，支持分页 |
| [US-028](#us-028) | [获取问题管理详情](../技术实现/API/问题管理接口文档.md#获取问题管理详情) | `GET /issue` | 获取问题的完整信息，包括描述、关联模型位置、处理历史等 |
| [US-029](#us-029) | [问题完成](../技术实现/API/问题管理接口文档.md#问题完成) | `POST /issue/completed` | 将问题标记为已完成，更新问题状态，完成问题处理闭环 |
| [US-030](#us-030) | [档案恢复到原处](../技术实现/API/回收站接口文档.md#档案恢复到原处) | `PUT /trash/put-back` | 将回收站中的档案恢复到原位置，文件夹会递归恢复所有内容 |
| [US-031](#us-031) | [立即删除记录](../技术实现/API/回收站接口文档.md#立即删除记录) | `DELETE /trash/delete-immediately` | 立即删除回收站记录，支持批量删除，物理删除不可恢复 |
| [US-032](#us-032) | [清空回收站](../技术实现/API/回收站接口文档.md#清空回收站) | `DELETE /trash/empty` | 清空当前用户在回收站的所有记录，需要用户二次确认 |
| [US-033](#us-033) | [获取回收站记录列表](../技术实现/API/回收站接口文档.md#获取回收站记录列表) | `GET /trash/list` | 查询回收站记录列表，只返回当前用户删除的记录，支持分页 |
| [US-034](#us-034) | [获取根目录文件夹权限](../技术实现/API/文档权限接口文档.md#获取根目录文件夹权限) | `GET /doc/get-root-permission` | 查看根目录文件夹的权限设置，返回restrict_write或none |
| [US-035](#us-035) | [设置根目录文件夹权限](../技术实现/API/文档权限接口文档.md#设置根目录文件夹权限) | `POST /doc/set-root-permission` | 设置根目录文件夹权限，只有项目管理员可操作，影响所有项目成员 |
| [US-036](#us-036) | [设置文档权限](../技术实现/API/文档权限接口文档.md#设置文档权限) | `POST /doc/set-doc-permission` | 为特定文档设置用户权限，实现细粒度权限控制 |
| [US-037](#us-037) | [查询文档权限](../技术实现/API/文档权限接口文档.md#查询文档权限) | `GET /doc/get-doc-permission` | 查询文档的所有权限配置，包括用户和权限值 |
| [US-038](#us-038) | [删除文档权限](../技术实现/API/文档权限接口文档.md#删除文档权限) | `DELETE /doc/del-doc-permission` | 删除文档的权限设置，删除后用户使用根目录基础权限 |
| [US-039](#us-039) | [修改文档权限](../技术实现/API/文档权限接口文档.md#修改文档权限) | `PUT /doc/update-doc-permission` | 更新文档的权限设置，修改用户的访问权限 |
| [US-040](#us-040) | [创建轻量化任务](../技术实现/API/转换任务接口文档.md#创建轻量化任务) | `POST /trans/task/start` | 针对未开启自动转换的项目，手动创建轻量化转换任务 |
| [US-041](#us-041) | [重试轻量化任务](../技术实现/API/转换任务接口文档.md#重试轻量化任务) | `POST /trans/task/retry` | 重试失败的转换任务，任务状态重置为待处理 |
| [US-042](#us-042) | [拾取轻量化任务](../技术实现/API/转换任务接口文档.md#拾取轻量化任务) | `GET /trans/task/pickup` | 转换引擎客户端专属接口，拾取待处理的转换任务 |
| [US-043](#us-043) | [轻量化任务进度上报](../技术实现/API/转换任务接口文档.md#轻量化任务进度上报) | `POST /trans/task/progress/report` | 转换引擎客户端上报转换进度，进度值范围0-100 |
| [US-044](#us-044) | [上传转换结果](../技术实现/API/转换任务接口文档.md#上传转换结果) | `POST /trans/task/upload` | 转换引擎客户端上传转换完成的结果文件 |
| [US-045](#us-045) | [下载任务模型数据](../技术实现/API/转换任务接口文档.md#下载任务模型数据) | `GET /trans/task/download` | 转换引擎客户端下载需要转换的原始模型文件，支持Range分片 |
| [US-046](#us-046) | [获取转换引擎参数](../技术实现/API/转换客户端接口文档.md#获取转换引擎参数) | `GET /trans/client/param` | 获取转换引擎的参数配置，包括转换格式、质量设置等 |
| [US-047](#us-047) | [获取存储用量信息](../技术实现/API/存储接口文档.md#获取存储用量信息) | `GET /storage` | 查看项目的存储用量信息，包括已用空间、总空间、使用率 |
| [US-048](#us-048) | [创建文件审批 Review](../技术实现/API/文件审批接口文档.md#创建文件审批-review) | `POST /reviews` | 选择模板与文件创建 Review，生成 version 快照并开流程 |
| [US-049](#us-049) | [Workflow 模板管理](../技术实现/API/文件审批接口文档.md#workflow-模板管理) | `POST /workflow-templates` · `POST /workflow-templates/{id}/enable` · `POST /workflow-templates/{id}/disable` | Project Admin 强校验；403 FORBIDDEN_PROJECT_ADMIN_REQUIRED；409 TEMPLATE_INITIATOR_RESOLVE_EMPTY |
| [US-050](#us-050) | [查询 Review 列表](../技术实现/API/文件审批接口文档.md#查询-review-列表含-my-tasks-筛选) | `GET /reviews?myTasks=true` | 列表可见性隔离；My Tasks 仅展示 `Review.status=Open` 且 `Current_Step.status=Open` 且候选者包含当前用户 |
| [US-051](#us-051) | [提交审批（Submit）](../技术实现/API/文件审批接口文档.md#提交审批submit) | `POST /reviews/{reviewId}/steps/{stepId}/submit` | Single/Group/MinN 流转；403 NOT_STEP_CANDIDATE；409 STEP_NOT_OPEN |
| [US-052](#us-052) | [预览档案](../技术实现/API/文档管理接口文档.md#预览档案) | `GET /doc/preview?version_id={versionId}` | Viewer 打开快照 version_id，沿用 DMS 权限，权限不足提示 |
| [US-053](#us-053) | [保存 Final 决策](../技术实现/API/文件审批接口文档.md#保存-final-决策) | `POST /reviews/{reviewId}/final/decisions` | 每文件必选 label；409 FINAL_DECISIONS_INCOMPLETE |
| [US-054](#us-054) | [提交审批（Submit）](../技术实现/API/文件审批接口文档.md#提交审批submit) | `POST /reviews/{reviewId}/steps/{stepId}/submit` | Final Step 提交时自动检测：所有文件已决策 + Target Folder 可访问 → 自动 Close Review + 自动复制 APPROVE 文件到 targetFolder，记录 copy_result（SUCCESS/FAIL/SKIPPED），可部分成功；若检测不通过则 Review 保持 Open |
| [US-055](#us-055) | [发送通知](../技术实现/API/文件审批接口文档.md#发送通知) | `POST /notifications/send` | Created/Step Advanced/Closed/Overdue；Overdue 去重 |
| [US-056](#us-056) | [扫描并发送 Overdue 通知](../技术实现/API/文件审批接口文档.md#扫描并发送-overdue-通知) | `POST /notifications/overdue/scan` | 扫描 Open steps，记录 last_overdue_notified_at 去重 |
| [US-057](#us-057) | [查询 Review 事件日志与 Timeline](../技术实现/API/文件审批接口文档.md#查询-review-事件日志与-timeline) | `GET /reviews/{reviewId}/events` | 返回事件流与 Step 聚合信息，按时间倒序 |
| [US-058](#us-058) | [作废 Review (Void)](../技术实现/API/文件审批接口文档.md#作废-review-void) | `POST /reviews/{reviewId}/void` | 仅 Open 可作废；403 FORBIDDEN_PROJECT_ADMIN_REQUIRED；409 REVIEW_NOT_OPEN |
| [US-059](#us-059) | [查询 Review 步骤列表](../技术实现/API/文件审批接口文档.md#查询-review-步骤列表) | `GET /reviews/{reviewId}/steps` | 返回 step 状态与 due_date；提交非 Open 返回 409 STEP_NOT_OPEN |
| [US-060](#us-060) | [查询 Review 权限](../技术实现/API/文件审批接口文档.md#查询-review-权限) | `GET /reviews/{reviewId}/permissions` | 辅助接口：返回用户对该 Review 的所有操作权限（canSubmit/canDecide/canVoid/canView），前端根据权限显示/隐藏操作按钮 |
| [US-067](#us-067) | [创建 Transmittal](../技术实现/API/文件传输接口文档.md#创建-transmittal) | `POST /transmittals` | 创建并发送 Transmittal，冻结版本快照并触发邮件通知 |
| [US-068](#us-068) | [查询 Transmittal 列表](../技术实现/API/文件传输接口文档.md#查询-transmittal-列表) | `GET /transmittals` | 列表可见性隔离，返回当前用户状态 |
| [US-069](#us-069) | [获取 Transmittal 详情](../技术实现/API/文件传输接口文档.md#获取-transmittal-详情) | `GET /transmittals/{transmittalId}` | 返回详情与文件快照；访问触发 Viewed |
| [US-070](#us-070) | [打包下载](../技术实现/API/文件传输接口文档.md#打包下载) | `GET /transmittals/{transmittalId}/download/zip` | 下载触发 Downloaded 状态 |
| [US-071](#us-071) | [创建 Transmittal](../技术实现/API/文件传输接口文档.md#创建-transmittal) · [获取 Transmittal 详情](../技术实现/API/文件传输接口文档.md#获取-transmittal-详情) · [打包下载](../技术实现/API/文件传输接口文档.md#打包下载) | `POST /transmittals` · `GET /transmittals/{transmittalId}` · `GET /transmittals/{transmittalId}/download/zip` | Received/Viewed/Downloaded 自动更新 |
| [US-072](#us-072) | [查询 Transmittal 活动日志](../技术实现/API/文件传输接口文档.md#查询-transmittal-活动日志) | `GET /transmittals/{transmittalId}/events` | 记录创建/查看/下载操作 |
| [US-073](#us-073) | [创建 Transmittal](../技术实现/API/文件传输接口文档.md#创建-transmittal) | `POST /transmittals` | 创建成功自动发送邮件通知 |

---

## 备注

1. 所有用户故事均基于实际接口功能反推，确保100%覆盖率。
2. 用户故事格式遵循标准："作为一个 <角色>，我希望 <需求>，从而 <业务价值>。"
3. 用户角色定义参考项目概览文档中的角色划分。
4. 业务价值描述结合了项目背景和用户痛点，确保用户故事的真实性和可执行性。
